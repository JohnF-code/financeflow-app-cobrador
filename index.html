<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cobrador App - v5.5</title>
    <!-- Cache Buster: v5.5.<?php echo time(); ?> -->
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="stylesheet" href="styles-new.css">
    
    <!-- 🆕 Módulos de almacenamiento robusto -->
    <script src="db.js?v=5.5"></script>
    <script src="crypto.js?v=5.5"></script>
    <script src="sync.js?v=5.5"></script>
    <script src="iphone-debug.js?v=5.5"></script>
    <style display="none">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ============ LIGHT/DARK MODE ============ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* LIGHT MODE (Default) */
        body.light-mode {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            color: #1a202c;
        }
        
        /* DARK MODE */
        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #4ade80; }
        .status-offline { background: #f87171; }
        
        /* Offline Status Banner */
        .offline-banner {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: auto !important;
            width: 100vw !important;
            max-width: none !important;
            height: auto !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 20px !important;
            margin: 0 !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4) !important;
            z-index: 2147483647 !important;
            display: none !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            text-align: center !important;
            min-height: 120px !important;
            max-height: none !important;
            box-sizing: border-box !important;
            overflow: visible !important;
            transform: none !important;
            opacity: 1 !important;
        }
        .offline-banner.show {
            display: flex !important;
        }
        .offline-banner.ready {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        .content {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .stat-card .value.success { color: #10b981; }
        .stat-card .value.warning { color: #f59e0b; }
        
        .list-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .list-header {
            background: #f8fafc;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #374151;
        }
        
        .list-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }
        
        .list-item:hover {
            background: #f8fafc;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .item-details {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .item-amount {
            font-weight: bold;
            color: #059669;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #374151;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fecaca;
        }
        
        .success {
            background: #f0fdf4;
            color: #16a34a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bbf7d0;
        }
        
        .offline-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 10px;
            text-align: center;
            font-size: 0.875rem;
            border-bottom: 1px solid #fbbf24;
        }
        
        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }
            
            .nav {
                flex-direction: column;
            }
            
            .nav-btn {
                min-width: auto;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .item-amount {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body class="light-mode">

    <!-- 🆕 Banner de Estado Offline -->
    <div id="offlineBanner" class="offline-banner">
        <div style="font-size: 32px; margin-bottom: 8px;">📦</div>
        <div style="font-weight: 700; font-size: 18px; line-height: 1.3;">Preparando modo offline...</div>
        <div style="font-size: 14px; opacity: 0.95; line-height: 1.4;">Descargando datos para trabajar sin conexión</div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1 id="headerTitle">Hola, Cobrador<span class="status-indicator status-online" id="statusIndicator"></span></h1>
                <span id="offlineBadge" style="display:none;background:#ff4444;color:white;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:700;margin-left:10px;box-shadow:0 0 15px rgba(255,68,68,0.5);">0</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="themeToggle" class="theme-toggle" title="Cambiar tema">🌓</button>
                <button id="logoutBtn">Salir</button>
            </div>
        </div>

        <!-- Offline Banner -->
        <div class="offline-banner" id="offlineBanner" style="display: none;">
            Modo offline - Los datos se sincronizarán cuando se restaure la conexión
        </div>

        <!-- HOME GRID -->
        <div id="homeGrid" class="home-grid">
            <div class="menu-card" data-view="pendientes">
                <span class="menu-card-icon">📋</span>
                <div class="menu-card-title">Cuotas Hoy</div>
                <div class="menu-card-subtitle">Gestionar cobros pendientes</div>
            </div>
            
            <div class="menu-card" data-view="clientes">
                <span class="menu-card-icon">👥</span>
                <div class="menu-card-title">Clientes</div>
                <div class="menu-card-subtitle">Ver y crear clientes</div>
            </div>
            
            <div class="menu-card" data-view="creditos">
                <span class="menu-card-icon">💰</span>
                <div class="menu-card-title">Créditos</div>
                <div class="menu-card-subtitle">Créditos activos</div>
            </div>
            
            <div class="menu-card" data-view="pagos">
                <span class="menu-card-icon">💵</span>
                <div class="menu-card-title">Mis Pagos</div>
                <div class="menu-card-subtitle">Historial de cobros</div>
            </div>
            
            <div class="menu-card full-width" data-view="resumen">
                <span class="menu-card-icon">📊</span>
                <div class="menu-card-title">Resumen</div>
                <div class="menu-card-subtitle">Dashboard y estadísticas</div>
            </div>
        </div>

        <!-- VIEWS CONTAINER -->
        <div id="viewsContainer" style="display: none;">
            <!-- Resumen View -->
            <div class="view active" id="resumen">
                <div class="view-header">
                    <div class="view-title">📊 Resumen</div>
                    <button class="back-btn" onclick="goHome()">🏠</button>
                </div>
                <div class="stats-grid">
                    <!-- Total Cobrado Hoy -->
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h3 style="color: white; font-size: 14px; margin-bottom: 8px;">Total cobrado hoy</h3>
                        <div class="value" style="color: white; font-size: 28px; font-weight: bold;" id="totalCollected">$0</div>
                    </div>
                    
                    <!-- Saldo Caja Hoy -->
                    <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                        <h3 style="color: white; font-size: 14px; margin-bottom: 8px;">Saldo Caja Hoy</h3>
                        <div class="value" style="color: white; font-size: 28px; font-weight: bold;" id="saldoCaja">$0</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-top: 4px;">Base - Créditos - Gastos + Cobrado</div>
                    </div>
                    
                    <!-- Créditos Hoy -->
                    <div class="stat-card">
                        <h3 style="font-size: 14px; color: #374151; margin-bottom: 8px;">Créditos Hoy</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 11px; color: #6b7280;">Cantidad</div>
                                <div style="font-size: 24px; font-weight: bold; color: #1f2937;" id="creditosCount">#0</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #6b7280;">Monto</div>
                                <div style="font-size: 20px; font-weight: bold; color: #f59e0b;" id="creditosMonto">$0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Base Hoy -->
                    <div class="stat-card">
                        <h3 style="font-size: 14px; color: #374151; margin-bottom: 8px;">Base Hoy</h3>
                        <div class="value" style="font-size: 24px; font-weight: bold; color: #6366f1;" id="baseDiaria">$0</div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Capital inicial del día</div>
                    </div>
                    
                    <!-- Gastos -->
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3 style="font-size: 14px; color: #374151; margin: 0;">Gastos</h3>
                            <button 
                                id="addGastoBtn"
                                style="width: 32px; height: 32px; border-radius: 50%; background: #ef4444; color: white; border: none; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                +
                            </button>
                        </div>
                        <div class="value" style="font-size: 24px; font-weight: bold; color: #ef4444;" id="gastos">$0</div>
                    </div>
                    
                    <!-- Clientes Hoy -->
                    <div class="stat-card">
                        <h3 style="font-size: 14px; color: #374151; margin-bottom: 8px;">Clientes Hoy</h3>
                        <div class="value" style="font-size: 24px; font-weight: bold; color: #8b5cf6;" id="clientesCount">#0</div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Clientes atendidos</div>
                    </div>
                    
                    <!-- Detalles del día -->
                    <div class="stat-card">
                        <h3 style="font-size: 14px; color: #374151; margin-bottom: 8px;">Detalles del día</h3>
                        <div style="text-align: left; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                <span style="font-size: 13px; color: #6b7280;">Pagos sincronizados:</span>
                                <span style="font-size: 16px; font-weight: bold; color: #10b981;" id="syncedPayments">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 13px; color: #6b7280;">Pendientes de enviar:</span>
                                <span style="font-size: 16px; font-weight: bold; color: #f59e0b;" id="pendingPayments">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cuotas Pendientes View -->
            <div class="view" id="pendientes">
                <div class="view-header">
                    <div class="view-title">📋 Cuotas Hoy</div>
                    <button class="back-btn" onclick="goHome()">🏠</button>
                </div>
                <div class="list-container">
                    <div class="list-header">Cuotas Pendientes de Hoy</div>
                    
                    <!-- Search Bar -->
                    <div style="margin-bottom: 15px;">
                        <input 
                            type="text" 
                            id="searchPendientes" 
                            placeholder="🔍 Buscar por nombre o cédula..."
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;">
                    </div>
                    
                    <div id="pendingQuotasList">
                        <div class="loading">Cargando cuotas...</div>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="paginationPendientes" style="display: none; margin-top: 15px; text-align: center;"></div>
                </div>
            </div>

            <!-- Clientes View -->
            <div class="view" id="clientes">
                <div class="view-header" style="display:flex;justify-content:space-between;align-items:center;padding:15px 20px;">
                    <div class="view-title">👥 Clientes</div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button 
                            onclick="showCreateClientForm()" 
                            style="
                                padding: 8px 16px;
                                font-size: 14px;
                                font-weight: 600;
                                background: #f59e0b;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                                transition: all 0.3s ease;
                            "
                            onmouseover="this.style.background='#d97706';this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.5)';"
                            onmouseout="this.style.background='#f59e0b';this.style.boxShadow='0 2px 8px rgba(245, 158, 11, 0.3)';">
                            ➕ Nuevo
                        </button>
                        <button class="back-btn" onclick="goHome()">🏠</button>
                    </div>
                </div>
                
                <div class="list-container">
                    <div class="list-header">Mis Clientes</div>
                    
                    <!-- Search Bar -->
                    <div style="margin-bottom: 15px;">
                        <input 
                            type="text" 
                            id="searchClientes" 
                            placeholder="🔍 Buscar por nombre, cédula o teléfono..."
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;">
                    </div>
                    
                    <div id="clientsList">
                        <div class="loading">Cargando clientes...</div>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="paginationClientes" style="display: none; margin-top: 15px; text-align: center;"></div>
                </div>
            </div>

            <!-- Créditos View -->
            <div class="view" id="creditos">
                <div class="view-header" style="display:flex;justify-content:space-between;align-items:center;padding:15px 20px;">
                    <div class="view-title">💰 Créditos</div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button 
                            onclick="showCreateCreditForm()" 
                            style="
                                padding: 8px 16px;
                                font-size: 14px;
                                font-weight: 600;
                                background: #f59e0b;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                                transition: all 0.3s ease;
                            "
                            onmouseover="this.style.background='#d97706';this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.5)';"
                            onmouseout="this.style.background='#f59e0b';this.style.boxShadow='0 2px 8px rgba(245, 158, 11, 0.3)';">
                            ➕ Nuevo
                        </button>
                        <button class="back-btn" onclick="goHome()">🏠</button>
                    </div>
                </div>
                
                <div class="list-container">
                    <div class="list-header">Créditos Activos</div>
                    
                    <!-- Search Bar -->
                    <div style="margin-bottom: 15px;">
                        <input 
                            type="text" 
                            id="searchCreditos" 
                            placeholder="🔍 Buscar por cliente o cédula..."
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;">
                    </div>
                    
                    <div id="creditsList">
                        <div class="loading">Cargando créditos...</div>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="paginationCreditos" style="display: none; margin-top: 15px; text-align: center;"></div>
                </div>
            </div>

            <!-- Mis Pagos View -->
            <div class="view" id="pagos">
                <div class="view-header">
                    <div class="view-title">💵 Mis Pagos</div>
                    <button class="back-btn" onclick="goHome()">🏠</button>
                </div>
                <div class="list-container">
                    <div class="list-header">Mis Pagos Registrados</div>
                    
                    <!-- Search Bar -->
                    <div style="margin-bottom: 15px;">
                        <input 
                            type="text" 
                            id="searchPagos" 
                            placeholder="🔍 Buscar por cliente o cédula..."
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;">
                    </div>
                    
                    <div id="paymentsList">
                        <div class="loading">Cargando pagos...</div>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="paginationPagos" style="display: none; margin-top: 15px; text-align: center;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js?v=4.7"></script>
    <script src="search-pagination.js?v=4.7"></script>
    <script src="payment-forms.js?v=4.7"></script>
    <script>
        // Global app state
        const APP = {
            supabase: null,
            collectorContext: null,
            timezone: 'America/Bogota', // Default timezone
            isOnline: navigator.onLine,
            offlineData: {
                payments: [],
                credits: [],
                clients: []
            },
            gpsEnabled: false,
            lastLocation: null
        };

        // 🆕 loadOfflineData() y saveOfflineData() eliminadas - ahora usa IndexedDB en db.js

        // ============ GPS FUNCTIONS ============
        
        // Check if GPS is already authorized
        function checkGpsAuthorization() {
            const gpsAuth = localStorage.getItem('gps_authorized');
            return gpsAuth === 'true';
        }

        // Get current location (silent)
        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalización no soportada'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        APP.lastLocation = location;
                        resolve(location);
                    },
                    (error) => {
                        console.error('GPS Error:', error);
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,  // Use GPS on mobile
                        timeout: 10000,            // 10 seconds max
                        maximumAge: 0              // Don't use cache
                    }
                );
            });
        }

        // Activate GPS (first time)
        async function activateGps() {
            const btn = document.getElementById('activateGpsBtn');
            const errorDiv = document.getElementById('gpsError');
            const instructionsDiv = document.getElementById('gpsInstructions');
            
            try {
                // Check if HTTPS (required for mobile)
                const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
                
                if (!isSecure) {
                    throw {
                        code: 'HTTPS_REQUIRED',
                        message: 'Se requiere HTTPS para acceder al GPS en móviles'
                    };
                }
                
                btn.textContent = '⏳ Solicitando permiso...';
                btn.disabled = true;
                errorDiv.style.display = 'none';
                
                // Show instructions for mobile
                instructionsDiv.innerHTML = '<strong>👆 Mira en la parte superior de tu pantalla</strong><br>Aparecerá un mensaje del navegador. Presiona <strong>"Permitir"</strong> para continuar.';
                instructionsDiv.style.display = 'block';
                
                // Request GPS permission
                const location = await getCurrentLocation();
                
                // Save authorization
                localStorage.setItem('gps_authorized', 'true');
                APP.gpsEnabled = true;
                
                // Hide lock screen
                document.getElementById('gpsLockScreen').style.display = 'none';
                
                console.log('✅ GPS activado:', location);
                
                // Continue with app initialization
                init();
                
            } catch (error) {
                console.error('❌ Error activating GPS:', error);
                
                instructionsDiv.style.display = 'none';
                
                let errorMsg = '';
                let helpText = '';
                const settingsBtn = document.getElementById('openSettingsBtn');
                
                // Detect browser
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                const isFirefox = /Firefox/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                
                switch(error.code) {
                    case 1: // PERMISSION_DENIED
                        errorMsg = '❌ Permiso bloqueado por el navegador';
                        
                        if (isChrome) {
                            helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;text-align:left;"><strong>📱 Chrome - Cómo activar:</strong><ol style="margin:8px 0;padding-left:20px;line-height:1.8;"><li>Toca el <strong>candado 🔒</strong> o los <strong>3 puntos ⋮</strong> arriba</li><li>Busca <strong>"Permisos"</strong> o <strong>"Configuración del sitio"</strong></li><li>Toca <strong>"Ubicación"</strong></li><li>Selecciona <strong>"Permitir"</strong></li><li>Recarga esta página (desliza hacia abajo)</li></ol><p style="margin:8px 0 0;font-size:12px;color:#92400e;"><strong>💡 Tip:</strong> Si no aparece el candado, toca el botón azul de abajo.</p></div>';
                        } else if (isFirefox) {
                            helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;text-align:left;"><strong>📱 Firefox - Cómo activar:</strong><ol style="margin:8px 0;padding-left:20px;line-height:1.8;"><li>Toca el <strong>candado 🔒</strong> en la barra de direcciones</li><li>Toca <strong>"Permisos"</strong></li><li>Busca <strong>"Ubicación"</strong> y actívala</li><li>Recarga esta página</li></ol></div>';
                        } else if (isSafari) {
                            helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;text-align:left;"><strong>📱 Safari - Cómo activar:</strong><ol style="margin:8px 0;padding-left:20px;line-height:1.8;"><li>Ve a <strong>Ajustes</strong> del iPhone</li><li>Busca <strong>Safari</strong></li><li>Toca <strong>"Ubicación"</strong></li><li>Selecciona <strong>"Permitir"</strong></li><li>Vuelve a la app y recarga</li></ol></div>';
                        } else {
                            helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;text-align:left;"><strong>📱 Cómo activar el GPS:</strong><ol style="margin:8px 0;padding-left:20px;line-height:1.8;"><li>Busca el ícono de <strong>candado 🔒</strong> o <strong>ubicación 📍</strong> en la parte superior</li><li>Presiona sobre él</li><li>Selecciona <strong>"Permitir ubicación"</strong></li><li>Recarga la página</li></ol></div>';
                        }
                        
                        // Show settings button for Chrome/Firefox
                        if (isChrome || isFirefox) {
                            settingsBtn.style.display = 'block';
                            settingsBtn.onclick = openBrowserSettings;
                        }
                        break;
                        
                    case 2: // POSITION_UNAVAILABLE
                        errorMsg = '❌ GPS no disponible';
                        helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;text-align:left;"><strong>Verifica:</strong><ul style="margin:8px 0;padding-left:20px;line-height:1.8;"><li>Que el <strong>GPS esté activado</strong> en tu dispositivo (Ajustes → Ubicación)</li><li>Que tengas <strong>conexión a internet</strong> o señal GPS</li><li>Que estés en un <strong>lugar con buena señal</strong> (sal al exterior si es posible)</li></ul></div>';
                        break;
                        
                    case 3: // TIMEOUT
                        errorMsg = '⏱️ Tiempo de espera agotado';
                        helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;text-align:left;">El GPS está tardando mucho. Intenta:<ul style="margin:8px 0;padding-left:20px;line-height:1.8;"><li><strong>Salir al exterior</strong> (mejor señal)</li><li><strong>Reiniciar el GPS</strong> de tu dispositivo</li><li><strong>Esperar unos segundos</strong> y reintentar</li></ul></div>';
                        break;
                        
                    default:
                        // Check for HTTPS error
                        if (error.code === 'HTTPS_REQUIRED') {
                            errorMsg = '🔒 Se requiere conexión segura (HTTPS)';
                            helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;text-align:left;"><strong>⚠️ Problema de seguridad:</strong><p style="margin:8px 0;">Los navegadores móviles (iPhone y Android) solo permiten acceso al GPS en sitios con <strong>HTTPS</strong> (conexión segura).</p><strong>📱 Solución permanente:</strong><ol style="margin:8px 0;padding-left:20px;line-height:1.8;"><li>Contacta al administrador del sistema</li><li>Solicita que active <strong>HTTPS</strong> en el dominio</li></ol><p style="margin:8px 0 0;font-size:12px;color:#92400e;"><strong>💡 Nota:</strong> Esta es una restricción de seguridad de los navegadores, no de la app.</p></div>';
                            
                            // Show skip button for HTTPS error
                            const skipBtn = document.getElementById('skipGpsBtn');
                            skipBtn.style.display = 'block';
                            skipBtn.onclick = skipGpsActivation;
                        } else {
                            errorMsg = '❌ Error desconocido';
                            helpText = '<div style="margin-top:10px;padding:10px;background:#fff7ed;border-radius:6px;">Intenta reiniciar tu navegador o dispositivo.</div>';
                        }
                }
                
                errorDiv.innerHTML = `<strong>${errorMsg}</strong>${helpText}`;
                errorDiv.style.display = 'block';
                
                btn.textContent = '🔄 Reintentar';
                btn.disabled = false;
            }
        }

        // Skip GPS activation (temporary - for HTTPS issues)
        function skipGpsActivation() {
            console.warn('⚠️ Usuario continuó sin GPS (HTTPS no disponible)');
            
            // Mark as skipped (not authorized, but allowed to continue)
            localStorage.setItem('gps_skipped', 'true');
            APP.gpsEnabled = false;
            
            // Hide lock screen
            document.getElementById('gpsLockScreen').style.display = 'none';
            
            // Show warning banner
            showWarning('⚠️ Funcionando sin GPS. Contacta al administrador para activar HTTPS y habilitar el GPS.');
            
            // Continue with app initialization
            init();
        }

        // Open browser settings (for Chrome/Firefox)
        function openBrowserSettings() {
            // Try to open site settings
            const url = window.location.href;
            
            // Chrome
            if (/Chrome/.test(navigator.userAgent)) {
                window.location.href = 'chrome://settings/content/location';
            }
            // Firefox
            else if (/Firefox/.test(navigator.userAgent)) {
                alert('📱 Para activar el GPS:\n\n1. Toca el candado 🔒 arriba\n2. Toca "Permisos"\n3. Activa "Ubicación"\n4. Recarga la página');
            }
            // Fallback
            else {
                alert('📱 Busca el ícono de candado 🔒 en la barra de direcciones y activa la ubicación.');
            }
        }
        
        // Show warning (for GPS skipped)
        function showWarning(message) {
            const existingWarning = document.getElementById('gpsWarningBanner');
            if (existingWarning) existingWarning.remove();
            
            const banner = document.createElement('div');
            banner.id = 'gpsWarningBanner';
            banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#fbbf24;color:#92400e;padding:12px;text-align:center;font-size:13px;font-weight:600;z-index:9999;box-shadow:0 2px 4px rgba(0,0,0,0.1);';
            banner.innerHTML = message;
            document.body.insertBefore(banner, document.body.firstChild);
        }

        // Banner de sincronización con opciones
        async function showSyncWarningBanner(failedCount, errCode, errMsg) {
            const existingBanner = document.getElementById('syncWarningBanner');
            if (existingBanner) existingBanner.remove();
            
            const banner = document.createElement('div');
            banner.id = 'syncWarningBanner';
            banner.style.cssText = 'position:fixed;top:60px;left:0;right:0;background:#fbbf24;color:#92400e;padding:12px;z-index:9998;box-shadow:0 2px 4px rgba(0,0,0,0.1);';
            
            banner.innerHTML = `
                <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;">
                    <div style="flex:1;">
                        <strong>⚠️ ${failedCount} operaciones pendientes</strong>
                        ${errCode || errMsg ? `<div style="font-size:11px;opacity:0.8;">${errCode} ${errMsg}</div>` : ''}
                    </div>
                    <div style="display:flex;gap:6px;">
                        <button onclick="toggleSyncDetails()" style="padding:6px 10px;background:rgba(0,0,0,0.1);border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;color:#92400e;" title="Ver detalles">
                            📋 Ver
                        </button>
                        <button onclick="manualSync()" style="padding:6px 10px;background:rgba(0,0,0,0.1);border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;color:#92400e;" title="Sincronizar ahora">
                            🔄 Sync
                        </button>
                    </div>
                </div>
                <div id="syncDetails" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.1);max-height:300px;overflow-y:auto;"></div>
            `;
            
            document.body.insertBefore(banner, document.body.firstChild);
        }

        // Toggle detalles de sincronización
        async function toggleSyncDetails() {
            const details = document.getElementById('syncDetails');
            if (!details) return;
            
            if (details.style.display === 'none') {
                // Cargar datos pendientes
                details.innerHTML = '<div style="text-align:center;padding:10px;">Cargando...</div>';
                details.style.display = 'block';
                
                try {
                    const [pagos, clientes, creditos] = await Promise.all([
                        getOfflineQueue('offline_pagos'),
                        getOfflineQueue('offline_clientes'),
                        getOfflineQueue('offline_creditos')
                    ]);
                    
                    const total = [...pagos, ...clientes, ...creditos];
                    
                    if (total.length === 0) {
                        details.innerHTML = '<div style="text-align:center;padding:10px;font-size:12px;">No hay operaciones pendientes</div>';
                        return;
                    }
                    
                    let html = '<div style="font-size:12px;">';
                    
                    if (pagos.length > 0) {
                        html += `<div style="margin-bottom:8px;"><strong>💳 Pagos (${pagos.length}):</strong></div>`;
                        pagos.forEach((p, i) => {
                            html += `<div style="padding:4px 8px;background:rgba(0,0,0,0.05);border-radius:4px;margin-bottom:4px;font-size:11px;">
                                ${i+1}. $${p.monto?.toLocaleString()} - ${p.fecha_pago} (ID: ${p.temp_id?.substring(0,20)}...)
                            </div>`;
                        });
                    }
                    
                    if (clientes.length > 0) {
                        html += `<div style="margin:10px 0 8px;"><strong>👥 Clientes (${clientes.length}):</strong></div>`;
                        clientes.forEach((c, i) => {
                            html += `<div style="padding:4px 8px;background:rgba(0,0,0,0.05);border-radius:4px;margin-bottom:4px;font-size:11px;">
                                ${i+1}. ${c.nombre} - ${c.cedula} (ID: ${c.temp_id?.substring(0,20)}...)
                            </div>`;
                        });
                    }
                    
                    if (creditos.length > 0) {
                        html += `<div style="margin:10px 0 8px;"><strong>💰 Créditos (${creditos.length}):</strong></div>`;
                        creditos.forEach((cr, i) => {
                            html += `<div style="padding:4px 8px;background:rgba(0,0,0,0.05);border-radius:4px;margin-bottom:4px;font-size:11px;">
                                ${i+1}. $${cr.monto_prestado?.toLocaleString()} (ID: ${cr.temp_id?.substring(0,20)}...)
                            </div>`;
                        });
                    }
                    
                    html += `</div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button onclick="copySyncList()" style="flex:1;padding:8px;background:rgba(0,0,0,0.1);border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;color:#92400e;">
                                📋 Copiar Lista
                            </button>
                            <button onclick="clearFailedSync()" style="flex:1;padding:8px;background:rgba(239,68,68,0.2);border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;color:#7f1d1d;">
                                🗑️ Eliminar Fallidos
                            </button>
                        </div>`;
                    
                    details.innerHTML = html;
                } catch (error) {
                    console.error('Error cargando detalles:', error);
                    details.innerHTML = '<div style="text-align:center;padding:10px;color:#ef4444;font-size:12px;">Error al cargar detalles</div>';
                }
            } else {
                details.style.display = 'none';
            }
        }

        // Copiar lista de sincronización
        async function copySyncList() {
            try {
                const [pagos, clientes, creditos] = await Promise.all([
                    getOfflineQueue('offline_pagos'),
                    getOfflineQueue('offline_clientes'),
                    getOfflineQueue('offline_creditos')
                ]);
                
                let text = '📋 OPERACIONES PENDIENTES\n\n';
                
                if (pagos.length > 0) {
                    text += `💳 PAGOS (${pagos.length}):\n`;
                    pagos.forEach((p, i) => {
                        text += `${i+1}. $${p.monto?.toLocaleString()} - ${p.fecha_pago} - ID: ${p.temp_id}\n`;
                    });
                    text += '\n';
                }
                
                if (clientes.length > 0) {
                    text += `👥 CLIENTES (${clientes.length}):\n`;
                    clientes.forEach((c, i) => {
                        text += `${i+1}. ${c.nombre} - ${c.cedula} - ID: ${c.temp_id}\n`;
                    });
                    text += '\n';
                }
                
                if (creditos.length > 0) {
                    text += `💰 CRÉDITOS (${creditos.length}):\n`;
                    creditos.forEach((cr, i) => {
                        text += `${i+1}. $${cr.monto_prestado?.toLocaleString()} - ID: ${cr.temp_id}\n`;
                    });
                }
                
                await navigator.clipboard.writeText(text);
                showSuccess('✅ Lista copiada al portapapeles');
            } catch (error) {
                console.error('Error copiando:', error);
                showError('Error al copiar la lista');
            }
        }

        // Sincronización manual
        async function manualSync() {
            showSuccess('🔄 Iniciando sincronización...');
            await syncOfflineData();
        }

        // Eliminar operaciones fallidas
        async function clearFailedSync() {
            if (!confirm('¿Eliminar TODAS las operaciones pendientes?\n\nEsto no se puede deshacer.')) {
                return;
            }
            
            try {
                await Promise.all([
                    clearSynced('offline_pagos'),
                    clearSynced('offline_clientes'),
                    clearSynced('offline_creditos')
                ]);
                
                const banner = document.getElementById('syncWarningBanner');
                if (banner) banner.remove();
                
                showSuccess('✅ Operaciones pendientes eliminadas');
                await updateConnectionStatus();
            } catch (error) {
                console.error('Error eliminando:', error);
                showError('Error al eliminar operaciones');
            }
        }

        // Check GPS on app start
        function checkGpsOnStart() {
            // Just init the app directly without GPS lock
            init();
        }

        // 🆕 Prepare offline data (cache everything needed for offline work)
        async function prepareOfflineData() {
            const banner = document.getElementById('offlineBanner');
            
            try {
                banner.classList.add('show');
                updateBanner('📦', 'Preparando datos offline...', 'Descargando información para trabajar sin conexión');
                
                // 1. Cache clientes
                updateBanner('👥', 'Descargando clientes...', 'Paso 1 de 5');
                const { data: clientes } = await APP.supabase
                    .from('clients')
                    .select('*')
                    .eq('panel_id', APP.collectorContext.panelId)
                    .order('nombre', { ascending: true });
                
                if (clientes?.length) {
                    await saveToCache('clientes_cache', clientes);
                    console.log(`✅ ${clientes.length} clientes cacheados`);
                }
                
                // 2. Cache préstamos activos completos
                updateBanner('💰', 'Descargando préstamos activos...', 'Paso 2 de 5');
                const { data: prestamos } = await APP.supabase
                    .from('prestamos')
                    .select(`
                        id, cliente_id, cuota_diaria, estado,
                        saldo_total_pendiente, monto_total,
                        fecha_inicio, fecha_fin,
                        clients:cliente_id(nombre, cedula, telefono)
                    `)
                    .eq('panel_id', APP.collectorContext.panelId)
                    .in('estado', ['activo', 'en_cobranza'])
                    .order('fecha_inicio', { ascending: false });
                
                if (prestamos?.length) {
                    await saveToCache('prestamos_detalle_cache', prestamos);
                    console.log(`✅ ${prestamos.length} préstamos cacheados`);
                }
                
                // 3. Cache cuotas pendientes
                updateBanner('📅', 'Descargando cuotas pendientes...', 'Paso 3 de 5');
                const { data: cuotas } = await APP.supabase
                    .from('cuotas')
                    .select(`
                        id, prestamo_id, fecha_vencimiento, 
                        saldo_pendiente, estado
                    `)
                    .eq('cobrador_id', APP.collectorContext.collectorId)
                    .neq('estado', 'pagada')
                    .order('fecha_vencimiento', { ascending: true });
                
                if (cuotas?.length) {
                    await saveToCache('cuotas_cache', cuotas);
                    console.log(`✅ ${cuotas.length} cuotas cacheadas`);
                }
                
                // 4. Cache settings
                updateBanner('⚙️', 'Descargando configuración...', 'Paso 4 de 5');
                await cacheSettings();
                
                // 5. Cache pagos recientes (últimos 30 días)
                updateBanner('💳', 'Descargando pagos recientes...', 'Paso 5 de 5');
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const { data: pagos } = await APP.supabase
                    .from('pagos')
                    .select('*')
                    .eq('cobrador_id', APP.collectorContext.collectorId)
                    .gte('fecha_pago', thirtyDaysAgo.toISOString())
                    .order('fecha_pago', { ascending: false });
                
                if (pagos?.length) {
                    await saveToCache('pagos_cache', pagos);
                    console.log(`✅ ${pagos.length} pagos cacheados`);
                }
                
                // Mostrar confirmación de éxito
                banner.classList.add('ready');
                updateBanner('✅', '¡Listo para trabajar offline!', `${clientes?.length || 0} clientes, ${prestamos?.length || 0} créditos, ${cuotas?.length || 0} cuotas`);
                
                // Sincronizar datos pendientes
                await syncOfflineData();
                
                // Auto-cerrar después de 5 segundos
                setTimeout(() => {
                    banner.classList.remove('show');
                }, 5000);
                
            } catch (error) {
                console.error('❌ Error preparando datos offline:', error);
                updateBanner('⚠️', 'Error al descargar datos', 'Algunos datos pueden no estar disponibles offline');
                setTimeout(() => banner.classList.remove('show'), 6000);
            }
        }
        
        function updateBanner(icon, title, subtitle) {
            const banner = document.getElementById('offlineBanner');
            if (!banner) return;
            
            banner.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 8px;">${icon}</div>
                <div style="font-weight: 700; font-size: 18px; line-height: 1.3;">${title}</div>
                <div style="font-size: 14px; opacity: 0.95; line-height: 1.4;">${subtitle}</div>
            `;
        }

        // Initialize app
        async function init() {
            try {
                console.log('🚀 Iniciando Cobrador App v3.0...');
                
                // 🆕 1. Inicializar IndexedDB
                try {
                    await initDB();
                    console.log('✅ IndexedDB inicializado');
                } catch (dbError) {
                    console.warn('⚠️ IndexedDB falló, usando localStorage:', dbError);
                }
                
                // 🆕 2. Inicializar sistema de cifrado
                try {
                    await initCrypto();
                    console.log('✅ Sistema de cifrado inicializado');
                } catch (cryptoError) {
                    console.warn('⚠️ Cifrado no disponible:', cryptoError);
                }
                
                // 3. Initialize Supabase
                APP.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // 4. Check authentication
                const { data: { session } } = await APP.supabase.auth.getSession();
                if (!session) {
                    showLogin();
                    return;
                }
                
                // 5. Get collector context
                await getCollectorContext();
                
                console.log('📍 About to setup event listeners...');
                
                // 6. Setup event listeners
                setupEventListeners();
                
                console.log('📍 Event listeners setup complete, loading data...');
                
                // 7. Load initial data (online) OR from cache (offline)
                await loadDashboardData();
                
                // 8. Setup offline handling & connection listeners
                setupOfflineHandling();
                
                // 🆕 9. Pre-cache critical data for offline (if online)
                if (APP.isOnline && navigator.onLine) {
                    console.log('🔄 Online detectado - preparando datos offline...');
                    await prepareOfflineData();
                }
                
                console.log('✅ App inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error initializing app:', error);
                showError('Error al inicializar la aplicación');
                
                // Even if there's an error, try to setup event listeners
                console.log('⚠️ Trying to setup event listeners after error...');
                try {
                    setupEventListeners();
                } catch (e) {
                    console.error('Failed to setup event listeners:', e);
                }
            }
        }

        // Get collector context
        async function getCollectorContext() {
            try {
                const { data: { user } } = await APP.supabase.auth.getUser();
                if (!user) throw new Error('No user found');

                console.log('Auth user:', user);

                // Extraer nombre del user_metadata o del email
                let collectorName = 'Cobrador';
                if (user.user_metadata?.nombre) {
                    // Si hay nombre en metadata, usar solo la primera palabra
                    collectorName = user.user_metadata.nombre.split(' ')[0];
                } else {
                    // Si no, extraer del email (antes del @)
                    const emailName = user.email?.split('@')[0] || 'Cobrador';
                    // Capitalizar primera letra
                    collectorName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
                }

                // Try collectors table first
                let { data: collector, error } = await APP.supabase
                    .from('collectors')
                    .select('id, panel_id, user_id')
                    .eq('user_id', user.id)
                    .single();

                console.log('Collectors query result:', { collector, error });

                // If not found, try cobradores table
                if (error || !collector) {
                    const { data: cobrador, error: err2 } = await APP.supabase
                        .from('cobradores')
                        .select('id, panel_id, user_id')
                        .eq('user_id', user.id)
                        .single();
                    
                    console.log('Cobradores query result:', { cobrador, err2 });
                    
                    if (err2 && err2.code !== 'PGRST116') {
                        console.error('Error querying cobradores:', err2);
                    }
                    
                    if (cobrador) {
                        collector = cobrador;
                    }
                }

                if (!collector) {
                    console.error('❌ No se encontró cobrador para este usuario');
                    // Logout automático si no hay cobrador
                    await APP.supabase.auth.signOut();
                    showError('No se encontró el cobrador asociado a este usuario. Cerrando sesión...');
                    setTimeout(() => {
                        showLogin();
                    }, 2000);
                    throw new Error('Collector not found in collectors or cobradores table');
                }

                console.log('🕐 Fetching timezone for panel:', collector.panel_id);
                
                // Get timezone from settings
                try {
                    const { data: tzData, error: tzError } = await APP.supabase
                        .from('settings')
                        .select('value')
                        .eq('panel_id', collector.panel_id)
                        .eq('key', 'timezone')
                        .maybeSingle();
                    
                    console.log('🕐 Timezone query result:', { tzData, tzError });
                    APP.timezone = (tzData?.value || 'America/Bogota');
                    console.log('Timezone loaded:', APP.timezone);
                } catch (tzErr) {
                    console.error('Error loading timezone, using default:', tzErr);
                    APP.timezone = 'America/Bogota';
                }

                APP.collectorContext = {
                    panelId: collector.panel_id,
                    collectorId: collector.id,
                    userId: user.id,
                    collectorName: collectorName,
                    userEmail: user.email
                };

                // Update header with collector name
                const headerTitle = document.getElementById('headerTitle');
                if (headerTitle) {
                    headerTitle.innerHTML = `Hola, ${collectorName} <span class="status-indicator status-online" id="statusIndicator"></span>`;
                }

                console.log('✅ Collector context loaded:', APP.collectorContext);
                
                // 🆕 Cache settings del panel para cálculos offline
                await cacheSettings();
                
                console.log('📍 getCollectorContext() completed successfully');
                return; // Exit function successfully
            } catch (error) {
                console.error('❌ Error getting collector context:', error);
                showError('No se pudo cargar el contexto del cobrador: ' + error.message);
                throw error;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('🔧 Starting setupEventListeners()...');
            
            // Navigation - usar event delegation para asegurar que funcione
            // Home Grid - event delegation for menu cards
            const homeGrid = document.getElementById('homeGrid');
            console.log('Setting up home grid:', homeGrid);
            if (homeGrid) {
                homeGrid.addEventListener('click', (e) => {
                    const card = e.target.closest('.menu-card');
                    if (card && card.dataset.view) {
                        const view = card.dataset.view;
                        console.log('Menu card clicked, view:', view);
                        switchView(view);
                    }
                });
                console.log('✅ Home grid event listener attached');
            } else {
                console.error('❌ homeGrid not found!');
            }
            
            // BACKUP: Also add direct listeners to each nav button
            const navButtons = document.querySelectorAll('.nav-btn');
            console.log('Found nav buttons:', navButtons.length);
            navButtons.forEach((btn, index) => {
                const view = btn.dataset.view;
                console.log(`  Button ${index}: ${view}`);
                btn.addEventListener('click', (e) => {
                    console.log(`🎯 Direct click on button: ${view}`);
                    e.preventDefault();
                    e.stopPropagation();
                    switchView(view);
                });
            });
            console.log('✅ Direct nav listeners attached to', navButtons.length, 'buttons');

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            console.log('🔍 Logout button found:', logoutBtn);
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔴 Logout button clicked!');
                    await logout();
                });
                console.log('✅ Logout event listener added');
            } else {
                console.error('❌ Logout button not found!');
            }

            // Add Gasto button
            const addGastoBtn = document.getElementById('addGastoBtn');
            console.log('🔍 Add Gasto button found:', addGastoBtn);
            if (addGastoBtn) {
                addGastoBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('➕ Add Gasto button clicked!');
                    showAddGastoForm();
                });
                console.log('✅ Add Gasto event listener added');
            } else {
                console.warn('⚠️ Add Gasto button not found');
            }

            // Note: Online/Offline listeners are now in setupOfflineHandling()
        }

        // Switch view
        function switchView(viewName) {
            console.log('Switching to view:', viewName);
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.add('active');
                console.log('View activated:', viewName, targetView);
            }

            // If switching to clients view, ensure create button is visible
            if (viewName === 'clientes') {
                const createBtn = document.getElementById('createClientBtn');
                console.log('Create client button:', createBtn, 'Display:', createBtn?.style.display);
            }

            // Load view data
            loadViewData(viewName);
        }

        // Load view data
        async function loadViewData(viewName) {
            try {
                switch (viewName) {
                    case 'pendientes':
                        await loadPendingQuotas();
                        break;
                    case 'clientes':
                        await loadClients();
                        break;
                    case 'creditos':
                        await loadCredits();
                        break;
                    case 'pagos':
                        await loadPayments();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${viewName}:`, error);
                showError(`Error al cargar ${viewName}`);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                console.log('📊 Cargando datos del dashboard...');
                
                // Check if online or offline
                if (!navigator.onLine) {
                    APP.isOnline = false;
                    console.log('📵 Offline - intentando cargar desde cache...');
                    
                    // 🆕 Try to load from IndexedDB cache
                    await loadFromCacheIfOffline();
                } else {
                    APP.isOnline = true;
                    console.log('🌐 Online - cargando desde Supabase...');
                    
                    // Load fresh data from Supabase
                    await Promise.all([
                        loadPendingQuotas(),
                        loadClients(),
                        loadCredits(),
                        loadPayments()
                    ]);
                    
                    // 🆕 Save to cache after successful load
                    await saveDashboardToCache();
                }
                
                updateDashboardStats();
            } catch (error) {
                console.error('❌ Error loading dashboard data:', error);
            }
        }

        // 🆕 Load dashboard from IndexedDB cache (offline mode)
        async function loadFromCacheIfOffline() {
            console.log('📂 Cargando datos desde cache IndexedDB...');
            
            try {
                // Load cached data
                const cachedQuotas = await loadFromCache('cuotas_cache');
                const cachedClients = await loadFromCache('clientes_cache');
                const cachedCredits = await loadFromCache('creditos_cache');
                const cachedPayments = await loadFromCache('pagos_cache');
                
                // Render data if available
                if (cachedQuotas.length > 0) {
                    console.log(`📋 Cuotas en cache: ${cachedQuotas.length}`);
                    // Render cuotas...
                }
                
                if (cachedClients.length > 0) {
                    console.log(`👥 Clientes en cache: ${cachedClients.length}`);
                    // Render clients...
                }
                
                if (cachedCredits.length > 0) {
                    console.log(`💰 Créditos en cache: ${cachedCredits.length}`);
                    // Render credits...
                }
                
                if (cachedPayments.length > 0) {
                    console.log(`💵 Pagos en cache: ${cachedPayments.length}`);
                    // Render payments...
                }
                
                // Show offline message in containers
                const quotasContainer = document.getElementById('pendingQuotasList');
                const clientsContainer = document.getElementById('clientsList');
                const creditsContainer = document.getElementById('creditsList');
                const paymentsContainer = document.getElementById('paymentsList');
                
                if (quotasContainer && cachedQuotas.length === 0) {
                    quotasContainer.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay datos en cache</p></div>';
                }
                if (clientsContainer && cachedClients.length === 0) {
                    clientsContainer.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay datos en cache</p></div>';
                }
                if (creditsContainer && cachedCredits.length === 0) {
                    creditsContainer.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay datos en cache</p></div>';
                }
                if (paymentsContainer && cachedPayments.length === 0) {
                    paymentsContainer.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay datos en cache</p></div>';
                }
                
            } catch (error) {
                console.error('❌ Error cargando desde cache:', error);
            }
        }

        // 🆕 Save dashboard data to IndexedDB cache
        async function saveDashboardToCache() {
            console.log('💾 Guardando datos en cache IndexedDB...');
            
            // Este método será llamado por cada función de carga individual
            // No necesitamos hacer nada aquí por ahora
            // Las funciones loadPendingQuotas, loadClients, etc. llamarán a saveToCache()
        }

        // Format date without timezone issues
        // Uses the configured timezone to display dates consistently with the backend
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Si la fecha ya viene como YYYY-MM-DD sin hora, usarla directamente
                if (!dateString.includes('T') && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                }
                
                // Si tiene timestamp, convertir usando timezone configurado
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    // Fallback: extraer solo la parte de fecha
                    const dateOnly = dateString.split('T')[0];
                    const [year, month, day] = dateOnly.split('-');
                    return `${day}/${month}/${year}`;
                }
                
                // Convertir a timezone local configurado
                // Nota: En JavaScript, toLocaleString con timeZone nos da la fecha correcta
                const localDate = date.toLocaleString('en-CA', { 
                    timeZone: APP.timezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).split(',')[0]; // YYYY-MM-DD
                
                const [year, month, day] = localDate.split('-');
                return `${day}/${month}/${year}`;
            } catch (error) {
                console.error('Error formatting date:', dateString, error);
                // Último fallback
                try {
                    const dateOnly = dateString.split('T')[0];
                    const [year, month, day] = dateOnly.split('-');
                    return `${day}/${month}/${year}`;
                } catch {
                    return dateString;
                }
            }
        }
        
        // Get current local date in YYYY-MM-DD format using configured timezone
        function getLocalToday() {
            try {
                const now = new Date();
                const localDate = now.toLocaleString('en-CA', { 
                    timeZone: APP.timezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).split(',')[0]; // YYYY-MM-DD
                return localDate;
            } catch (error) {
                console.error('Error getting local today:', error);
                return new Date().toISOString().split('T')[0];
            }
        }

        // 🆕 Cache préstamo completo con todas las cuotas (para pagos/recogidas offline)
        async function cachePrestamoCompleto(loanId) {
            try {
                // Obtener préstamo con cliente
                const { data: loan, error: loanError } = await APP.supabase
                    .from('prestamos')
                    .select(`
                        id, cliente_id, monto_prestado, cuota_diaria, total_dias,
                        fecha_inicio, estado, monto_pagado, saldo_pendiente,
                        clients:cliente_id (nombre, cedula, telefono)
                    `)
                    .eq('id', loanId)
                    .single();
                
                if (loanError) throw loanError;
                
                // Obtener todas las cuotas
                const { data: cuotas, error: cuotasError } = await APP.supabase
                    .from('cuotas')
                    .select('id, numero_cuota, fecha_vencimiento, estado, saldo_pendiente, monto_cuota')
                    .eq('prestamo_id', loanId)
                    .order('numero_cuota');
                
                if (cuotasError) throw cuotasError;
                
                // Calcular saldo total pendiente
                const saldoTotalPendiente = cuotas
                    ?.filter(c => c.estado !== 'pagada')
                    ?.reduce((sum, c) => sum + Number(c.saldo_pendiente || 0), 0) || 0;
                
                // Preparar préstamo completo
                const prestamoCompleto = {
                    ...loan,
                    saldo_total_pendiente: saldoTotalPendiente,
                    cuotas: cuotas || [],
                    cobrador_id: APP.collectorContext.collectorId,
                    ultima_actualizacion: Date.now()
                };
                
                // Guardar en cache
                const cached = await loadFromCache('prestamos_detalle_cache');
                const otherLoans = cached.filter(l => l.id !== loanId);
                await saveToCache('prestamos_detalle_cache', [...otherLoans, prestamoCompleto]);
                
                console.log(`💾 Préstamo ${loanId} cacheado completo`);
                return prestamoCompleto;
            } catch (error) {
                console.error(`❌ Error cacheando préstamo ${loanId}:`, error);
                return null;
            }
        }

        // 🆕 Cache settings del panel
        async function cacheSettings() {
            try {
                // Obtener TODOS los settings (no usar .single())
                const { data: settings, error } = await APP.supabase
                    .from('settings')
                    .select('*')
                    .eq('panel_id', APP.collectorContext.panelId);
                
                if (error) throw error;
                
                if (settings && settings.length > 0) {
                    const settingsWithTimestamp = settings.map(s => ({
                        ...s,
                        panel_id: APP.collectorContext.panelId,
                        ultima_actualizacion: Date.now()
                    }));
                    
                    await saveToCache('panel_settings_cache', settingsWithTimestamp);
                    console.log(`💾 ${settings.length} Settings cacheados`);
                }
            } catch (error) {
                console.error('❌ Error cacheando settings:', error);
            }
        }

        // 🆕 Render cuotas from cache (offline mode)
        function renderPendingQuotasFromCache(cachedData) {
            const container = document.getElementById('pendingQuotasList');
            if (!container || !cachedData || cachedData.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Sin datos</h3><p>No hay cuotas en cache</p></div>';
                return;
            }
            
            // Group by loan and render
            const loanGroups = {};
            cachedData.forEach(cuota => {
                if (!loanGroups[cuota.prestamo_id]) {
                    loanGroups[cuota.prestamo_id] = [];
                }
                loanGroups[cuota.prestamo_id].push(cuota);
            });
            
            let html = '<div style="background: rgba(255, 193, 7, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;"><strong>📵 Modo Offline</strong> - Datos del cache (pueden no estar actualizados)</div>';
            
            Object.keys(loanGroups).forEach(loanId => {
                const cuotas = loanGroups[loanId];
                const firstCuota = cuotas[0];
                
                html += `
                    <div class="quota-card">
                        <div class="quota-header">
                            <h3>${firstCuota.cliente_nombre || 'Cliente'}</h3>
                            <span class="badge badge-warning">Offline</span>
                        </div>
                        <div class="quota-body">
                            <p><strong>Préstamo:</strong> ${loanId}</p>
                            <p><strong>Total cuotas:</strong> ${cuotas.length}</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Load pending loans with details (similar to main panel)
        async function loadPendingQuotas() {
            console.log('🚀 INICIANDO loadPendingQuotas()');
            const container = document.getElementById('pendingQuotasList');
            if (!container) {
                console.error('❌ No se encontró el contenedor pendingQuotasList');
                return;
            }
            container.innerHTML = '<div class="loading">Cargando préstamos...</div>';

            try {
                // Check online status first
                if (!navigator.onLine) {
                    APP.isOnline = false;
                    updateConnectionStatus();
                }

                // 🆕 If offline, try to load from cache
                if (!APP.isOnline || !navigator.onLine) {
                    console.log('📵 Offline mode - loading from cache...');
                    const cachedLoans = await loadFromCache('cuotas_cache');
                    
                    if (cachedLoans && cachedLoans.length > 0) {
                        console.log(`📂 Loaded ${cachedLoans.length} loans from cache`);
                        console.log('📂 Primera cuota:', cachedLoans[0]);
                        
                        // Usar el mismo sistema de paginación que online
                        PAGINATION_STATE.pendientes.allData = cachedLoans;
                        PAGINATION_STATE.pendientes.filteredData = cachedLoans;
                        PAGINATION_STATE.pendientes.currentPage = 1;
                        
                        // Setup search listener
                        setupSearchListener('pendientes', ['clients.nombre', 'clients.cedula'], renderPendientes);
                        
                        // Render con paginación (mismo que online)
                        setTimeout(() => {
                            renderPendientes(cachedLoans);
                        }, 0);
                        return;
                    } else {
                        container.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay datos en cache. Conecta a internet para cargar las cuotas</p></div>';
                        return;
                    }
                }

                const today = getLocalToday();
                console.log('📅 Fecha local hoy:', today);
                console.log('Loading pending loans for today:', today);
                
                // Get active loans for this collector
                const { data: loans, error: loansError } = await APP.supabase
                    .from('prestamos')
                    .select(`
                        id,
                        cliente_id,
                        monto_prestado,
                        cuota_diaria,
                        total_dias,
                        fecha_inicio,
                        estado,
                        clients:cliente_id (
                            id,
                            nombre,
                            cedula
                        )
                    `)
                    .eq('panel_id', APP.collectorContext.panelId)
                    .eq('cobrador_id', APP.collectorContext.collectorId)
                    .in('estado', ['activo', 'vencido'])
                    .order('fecha_inicio', { ascending: false });

                if (loansError) throw loansError;

                console.log('📊 Préstamos activos encontrados:', loans?.length || 0);
                console.log('Préstamos:', loans);

                if (!loans || loans.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No hay préstamos activos</h3><p>No tienes préstamos asignados</p></div>';
                    return;
                }

                // For each loan, get cuotas summary
                const loansWithDetails = await Promise.all(loans.map(async (loan) => {
                    const { data: cuotas } = await APP.supabase
                        .from('cuotas')
                        .select('estado, saldo_pendiente, fecha_vencimiento, monto_cuota')
                        .eq('prestamo_id', loan.id)
                        .order('numero_cuota');
                    
                    const totalCuotas = cuotas?.length || 0;
                    const paidCuotas = cuotas?.filter(c => c.estado === 'pagada').length || 0;
                    const pendingAmount = cuotas?.reduce((sum, c) => {
                        if (c.estado !== 'pagada') {
                            return sum + Number(c.saldo_pendiente || 0);
                        }
                        return sum;
                    }, 0) || 0;
                    
                    // Calculate overdue days
                    let maxOverdue = 0;
                    const todayDate = new Date(today);
                    cuotas?.forEach(c => {
                        if (c.estado !== 'pagada') {
                            const dueDate = new Date(c.fecha_vencimiento);
                            if (dueDate < todayDate) {
                                const diffDays = Math.floor((todayDate - dueDate) / (1000 * 60 * 60 * 24));
                                maxOverdue = Math.max(maxOverdue, diffDays);
                            }
                        }
                    });
                    
                    const totalAmount = loan.cuota_diaria * loan.total_dias;
                    const paidAmount = totalAmount - pendingAmount;
                    const progress = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
                    
                    return {
                        ...loan,
                        totalCuotas,
                        paidCuotas,
                        pendingAmount,
                        daysOverdue: maxOverdue,
                        totalAmount,
                        paidAmount,
                        progress
                    };
                }));

                // Store data and render with pagination
                console.log('✅ Préstamos con detalles:', loansWithDetails.length);
                PAGINATION_STATE.pendientes.allData = loansWithDetails;
                PAGINATION_STATE.pendientes.filteredData = loansWithDetails;
                PAGINATION_STATE.pendientes.currentPage = 1;
                
                // Setup search listener
                setupSearchListener('pendientes', ['clients.nombre', 'clients.cedula'], renderPendientes);
                
                // Render with pagination
                renderPendientes(loansWithDetails);
                
                // 🆕 Save to cache for offline use
                await saveToCache('cuotas_cache', loansWithDetails);
                console.log('💾 Cuotas guardadas en cache');
                
                // 🆕 Cache préstamos completos para pagos/recogidas offline
                console.log('💾 Cacheando préstamos completos...');
                for (const loan of loans) {
                    await cachePrestamoCompleto(loan.id);
                }
                console.log(`✅ ${loans.length} préstamos cacheados completos`);
            } catch (error) {
                console.error('Error loading pending loans:', error);
                console.error('Error details:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                console.error('Context:', APP.collectorContext);
                
                // Intentar cargar desde cache si falla la red
                try {
                    const cachedLoans = await loadFromCache('cuotas_cache');
                    if (cachedLoans && cachedLoans.length > 0) {
                        console.log('⚠️ Error de red, cargando desde cache...');
                        PAGINATION_STATE.pendientes.allData = cachedLoans;
                        PAGINATION_STATE.pendientes.filteredData = cachedLoans;
                        PAGINATION_STATE.pendientes.currentPage = 1;
                        setupSearchListener('pendientes', ['clients.nombre', 'clients.cedula'], renderPendientes);
                        setTimeout(() => renderPendientes(cachedLoans), 0);
                        return;
                    }
                } catch (cacheError) {
                    console.error('Error cargando cache:', cacheError);
                }
                
                container.innerHTML = `<div class="error" style="padding:20px;text-align:center;">
                    <h3>⚠️ Error al cargar los préstamos</h3>
                    <p style="font-size:14px;color:#666;margin:10px 0;">${error.message || 'Error desconocido'}</p>
                    <button onclick="loadPendingQuotas()" style="margin-top:10px;padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;">
                        🔄 Reintentar
                    </button>
                </div>`;
            }
        }

        // Load clients
        async function loadClients() {
            const container = document.getElementById('clientsList');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Cargando clientes...</div>';

            try {
                // Check online status first
                if (!navigator.onLine) {
                    APP.isOnline = false;
                    updateConnectionStatus();
                }

                // 🆕 If offline, load from cache
                if (!APP.isOnline || !navigator.onLine) {
                    console.log('==========================================');
                    console.log('📵 CARGANDO CLIENTES OFFLINE');
                    console.log('  navigator.onLine:', navigator.onLine);
                    console.log('  APP.isOnline:', APP.isOnline);
                    
                    const cachedClients = await loadFromCache('clientes_cache');
                    console.log('  cachedClients:', cachedClients);
                    console.log('  cachedClients?.length:', cachedClients?.length);
                    
                    if (cachedClients && cachedClients.length > 0) {
                        console.log(`📂 Loaded ${cachedClients.length} clients from cache`);
                        console.log('  Primer cliente:', cachedClients[0]);
                        
                        PAGINATION_STATE.clientes.allData = cachedClients;
                        PAGINATION_STATE.clientes.filteredData = cachedClients;
                        PAGINATION_STATE.clientes.currentPage = 1;
                        
                        console.log('  Configurando search listener...');
                        setupSearchListener('clientes', ['nombre', 'cedula', 'telefono'], renderClientes);
                        
                        console.log('  Llamando renderClientes...');
                        // Forzar render inmediato y asegurar que el DOM esté listo
                        setTimeout(() => {
                            renderClientes(cachedClients);
                            console.log('  renderClientes completado');
                        }, 0);
                        console.log('==========================================');
                        return;
                    } else {
                        console.log('❌ No hay clientes en cache o cache vacio');
                        console.log('==========================================');
                        container.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay clientes en cache. Conecta a internet y navega por los menús para descargar datos.</p></div>';
                        return;
                    }
                }

                // Get ALL clients from the panel (like main app)
                const { data, error } = await APP.supabase
                    .from('clients')
                    .select('id, nombre, telefono, email, cedula')
                    .eq('panel_id', APP.collectorContext.panelId)
                    .order('nombre');

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No hay clientes</h3><p>No hay clientes registrados</p></div>';
                    return;
                }

                // Store data and render with pagination
                PAGINATION_STATE.clientes.allData = data;
                PAGINATION_STATE.clientes.filteredData = data;
                PAGINATION_STATE.clientes.currentPage = 1;
                
                // Setup search listener
                setupSearchListener('clientes', ['nombre', 'cedula', 'telefono'], renderClientes);
                
                // Render with pagination
                renderClientes(data);
                
                // 🆕 Save to cache for offline use
                await saveToCache('clientes_cache', data);
                console.log('💾 Clientes guardados en cache');
            } catch (error) {
                console.error('Error loading clients:', error);
                console.error('Context:', APP.collectorContext);
                container.innerHTML = `<div class="error">Error al cargar los clientes: ${error.message || 'Error desconocido'}</div>`;
            }
        }

        // Load credits
        async function loadCredits() {
            const container = document.getElementById('creditsList');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Cargando créditos...</div>';

            try {
                // Check online status first
                if (!navigator.onLine) {
                    APP.isOnline = false;
                    updateConnectionStatus();
                }

                // 🆕 If offline, load from cache
                if (!APP.isOnline || !navigator.onLine) {
                    console.log('📵 Offline mode - loading credits from cache...');
                    const cachedCredits = await loadFromCache('creditos_cache');
                    
                    if (cachedCredits && cachedCredits.length > 0) {
                        console.log(`📂 Loaded ${cachedCredits.length} credits from cache`);
                        PAGINATION_STATE.creditos.allData = cachedCredits;
                        PAGINATION_STATE.creditos.filteredData = cachedCredits;
                        PAGINATION_STATE.creditos.currentPage = 1;
                        setupSearchListener('creditos', ['clients.nombre', 'clients.cedula'], renderCreditos);
                        renderCreditos(cachedCredits);
                        return;
                    } else {
                        container.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay créditos en cache</p></div>';
                        return;
                    }
                }

                const { data, error } = await APP.supabase
                    .from('prestamos')
                    .select(`
                        id,
                        monto_prestado,
                        cuota_diaria,
                        total_dias,
                        estado,
                        fecha_inicio,
                        monto_pagado,
                        saldo_pendiente,
                        clients:cliente_id (
                            nombre,
                            telefono,
                            cedula
                        )
                    `)
                    .eq('panel_id', APP.collectorContext.panelId)
                    .eq('cobrador_id', APP.collectorContext.collectorId)
                    .eq('estado', 'activo')
                    .order('fecha_inicio', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No hay créditos activos</h3><p>No tienes créditos activos</p></div>';
                    return;
                }

                // Store data and render with pagination
                PAGINATION_STATE.creditos.allData = data;
                PAGINATION_STATE.creditos.filteredData = data;
                PAGINATION_STATE.creditos.currentPage = 1;
                
                // Setup search listener
                setupSearchListener('creditos', ['clients.nombre', 'clients.cedula'], renderCreditos);
                
                // Render with pagination
                renderCreditos(data);
                
                // 🆕 Save to cache for offline use
                await saveToCache('creditos_cache', data);
                console.log('💾 Créditos guardados en cache');
            } catch (error) {
                console.error('Error loading credits:', error);
                console.error('Context:', APP.collectorContext);
                container.innerHTML = `<div class="error">Error al cargar los créditos: ${error.message || 'Error desconocido'}</div>`;
            }
        }

        // Load payments
        async function loadPayments() {
            const container = document.getElementById('paymentsList');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Cargando pagos...</div>';

            try {
                // Check online status first
                if (!navigator.onLine) {
                    APP.isOnline = false;
                    updateConnectionStatus();
                }

                // 🆕 If offline, load from cache
                if (!APP.isOnline || !navigator.onLine) {
                    console.log('📵 Offline mode - loading payments from cache...');
                    const cachedPayments = await loadFromCache('pagos_cache');
                    
                    if (cachedPayments && cachedPayments.length > 0) {
                        console.log(`📂 Loaded ${cachedPayments.length} payments from cache`);
                        PAGINATION_STATE.pagos.allData = cachedPayments;
                        PAGINATION_STATE.pagos.filteredData = cachedPayments;
                        PAGINATION_STATE.pagos.currentPage = 1;
                        setupSearchListener('pagos', ['clients.nombre', 'clients.cedula'], renderPagos);
                        renderPagos(cachedPayments);
                        return;
                    } else {
                        container.innerHTML = '<div class="empty-state"><h3>⚠️ Modo Offline</h3><p>No hay pagos en cache</p></div>';
                        return;
                    }
                }

                const { data, error } = await APP.supabase
                    .from('pagos')
                    .select(`
                        id,
                        monto,
                        fecha_pago,
                        hora_pago,
                        estado,
                        created_at,
                        clients:cliente_id (
                            nombre,
                            cedula
                        ),
                        prestamos:prestamo_id (
                            id
                        )
                    `)
                    .eq('panel_id', APP.collectorContext.panelId)
                    .eq('cobrador_id', APP.collectorContext.collectorId)
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No hay pagos registrados</h3><p>No has registrado pagos aún</p></div>';
                    return;
                }

                // Store data and render with pagination
                PAGINATION_STATE.pagos.allData = data;
                PAGINATION_STATE.pagos.filteredData = data;
                PAGINATION_STATE.pagos.currentPage = 1;
                
                // Setup search listener
                setupSearchListener('pagos', ['clients.nombre', 'clients.cedula'], renderPagos);
                
                // Render with pagination
                renderPagos(data);

                // Update dashboard stats
                updateDashboardStatsWithPayments(data);
                
                // 🆕 Save to cache for offline use
                await saveToCache('pagos_cache', data);
                console.log('💾 Pagos guardados en cache');
            } catch (error) {
                console.error('Error loading payments:', error);
                console.error('Context:', APP.collectorContext);
                container.innerHTML = `<div class="error">Error al cargar los pagos: ${error.message || 'Error desconocido'}</div>`;
            }
        }

        // Update dashboard stats
        function updateDashboardStats() {
            loadTodayStats();
        }

        // Update dashboard stats with payments data
        function updateDashboardStatsWithPayments(payments) {
            const today = getLocalToday();
            const todayPayments = payments.filter(p => p.fecha_pago === today);
            
            const totalCollected = todayPayments.reduce((sum, p) => sum + Number(p.monto), 0);
            const quotasRegistered = todayPayments.length;
            
            // Update only existing elements
            const totalCollectedEl = document.getElementById('totalCollected');
            const syncedPaymentsEl = document.getElementById('syncedPayments');
            const pendingPaymentsEl = document.getElementById('pendingPayments');
            
            if (totalCollectedEl) totalCollectedEl.textContent = '$' + totalCollected.toLocaleString();
            if (syncedPaymentsEl) syncedPaymentsEl.textContent = quotasRegistered;
            if (pendingPaymentsEl) pendingPaymentsEl.textContent = APP.offlineData.payments.length;
        }

        // Load today's stats using optimized RPC
        async function loadTodayStats() {
            try {
                const today = getLocalToday();
                console.log('📊 Loading dashboard stats for:', today);
                
                // Call optimized RPC that returns all metrics in one query
                const { data, error } = await APP.supabase
                    .rpc('get_collector_daily_summary', {
                        p_collector_id: APP.collectorContext.collectorId,
                        p_fecha: today
                    });

                if (error) {
                    console.error('RPC error:', error);
                    throw error;
                }

                console.log('📊 Dashboard data received:', data);

                // Update all dashboard metrics
                document.getElementById('totalCollected').textContent = '$' + Number(data.total_cobrado || 0).toLocaleString();
                document.getElementById('saldoCaja').textContent = '$' + Number(data.saldo_caja || 0).toLocaleString();
                document.getElementById('creditosCount').textContent = '#' + (data.creditos_count || 0);
                document.getElementById('creditosMonto').textContent = '$' + Number(data.creditos_monto || 0).toLocaleString();
                document.getElementById('baseDiaria').textContent = '$' + Number(data.base_diaria || 0).toLocaleString();
                document.getElementById('gastos').textContent = '$' + Number(data.gastos || 0).toLocaleString();
                document.getElementById('clientesCount').textContent = '#' + (data.clientes_count || 0);
                document.getElementById('syncedPayments').textContent = data.pagos_sincronizados || 0;
                document.getElementById('pendingPayments').textContent = APP.offlineData.payments.length;
            } catch (error) {
                console.error('❌ Error loading dashboard stats:', error);
                // Show zeros on error
                document.getElementById('totalCollected').textContent = '$0';
                document.getElementById('saldoCaja').textContent = '$0';
                document.getElementById('creditosCount').textContent = '#0';
                document.getElementById('creditosMonto').textContent = '$0';
                document.getElementById('baseDiaria').textContent = '$0';
                document.getElementById('gastos').textContent = '$0';
                document.getElementById('clientesCount').textContent = '#0';
                document.getElementById('syncedPayments').textContent = '0';
                document.getElementById('pendingPayments').textContent = '0';
            }
        }

        // Register payment
        async function registerPayment(quotaId, amount, prestamoId, clienteId) {
            if (!APP.isOnline) {
                // Store offline
                APP.offlineData.payments.push({
                    cuota_id: quotaId,
                    prestamo_id: prestamoId,
                    cliente_id: clienteId,
                    monto: amount,
                    fecha_pago: getLocalToday(),
                    hora_pago: new Date().toTimeString().split(' ')[0],
                    status: 'pending_sync'
                });
                showSuccess('Pago guardado offline - se sincronizará cuando se restaure la conexión');
                return;
            }

            try {
                // Generate idempotency key to prevent duplicates
                const idempotencyKey = `${APP.collectorContext.collectorId}-${quotaId}-${Date.now()}`;
                
                const { error } = await APP.supabase
                    .from('pagos')
                    .insert({
                        panel_id: APP.collectorContext.panelId,
                        cliente_id: clienteId,
                        prestamo_id: prestamoId,
                        cobrador_id: APP.collectorContext.collectorId,
                        monto: amount,
                        fecha_pago: getLocalToday(),
                        hora_pago: new Date().toTimeString().split(' ')[0],
                        estado: 'registrado',
                        idempotency_key: idempotencyKey,
                        created_by: APP.collectorContext.userId
                    });

                if (error) throw error;

                showSuccess('Pago registrado exitosamente');
                loadPendingQuotas();
                loadPayments();
                updateDashboardStats();
            } catch (error) {
                console.error('Error registering payment:', error);
                showError('Error al registrar el pago: ' + error.message);
            }
        }

        // View client details
        function viewClientDetails(clientId) {
            // This would open a modal or navigate to client details
            console.log('View client details:', clientId);
        }

        // View credit details
        function viewCreditDetails(creditId) {
            // This would open a modal or navigate to credit details
            console.log('View credit details:', creditId);
        }

        // Show create client form (con overlay)
        function showCreateClientForm() {
            console.log('🆕 showCreateClientForm called');
            
            // Usar el mismo patrón de overlay que Registrar Pago
            document.body.insertAdjacentHTML('beforeend', `
                <div id="clientModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;">
                    <div style="background:white;border-radius:15px;padding:20px;max-width:400px;width:100%;max-height:90vh;overflow-y:auto;">
                        <h3 style="margin:0 0 15px;color:#333;">Crear Nuevo Cliente</h3>
                        <form id="newClientForm" style="display:grid;gap:12px;">
                            <div>
                                <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Nombre completo *</label>
                                <input type="text" id="clientName" class="form-input" required placeholder="Ej: Juan Pérez" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Cédula *</label>
                                <input type="text" id="clientCedula" class="form-input" required placeholder="Ej: 1234567890" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Teléfono *</label>
                                <input type="tel" id="clientPhone" class="form-input" placeholder="Ej: 3001234567" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
                            </div>
                            <div style="display:flex;gap:10px;margin-top:10px;">
                                <button type="submit" class="btn btn-success" style="flex:1;padding:12px;">Guardar Cliente</button>
                                <button type="button" onclick="hideCreateClientForm()" class="btn" style="flex:1;padding:12px;background:#6c757d;color:white;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `);

            document.getElementById('newClientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createClient();
            });
        }

        // Hide create client form
        function hideCreateClientForm() {
            document.getElementById('clientModal')?.remove();
        }

        // Create client
        async function createClient() {
            const submitBtn = document.querySelector('#newClientForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';

            try {
                // 🆕 FORZAR verificación de conexión ANTES de cualquier cosa
                const isReallyOffline = !navigator.onLine;
                APP.isOnline = navigator.onLine; // Actualizar siempre
                
                // 🆕 Debug crítico
                console.log('==========================================');
                console.log('🚀 createClient() INICIADO');
                console.log('📊 Estado de conexión:');
                console.log('  navigator.onLine:', navigator.onLine);
                console.log('  APP.isOnline (ACTUALIZADO):', APP.isOnline);
                console.log('  isReallyOffline:', isReallyOffline);
                console.log('  Condición (isReallyOffline):', isReallyOffline);
                
                // 🆕 Verificar que IndexedDB esté listo
                console.log('🔍 Verificando IndexedDB...');
                console.log('  DB.isSupported:', DB.isSupported);
                console.log('  DB.isReady:', DB.isReady);
                console.log('  DB.instance:', DB.instance ? 'Existe' : 'NULL');
                
                if (!DB.isSupported || !DB.isReady || !DB.instance) {
                    console.error('❌ IndexedDB no está listo!');
                    alert('⚠️ Base de datos local no inicializada.\nRecarga la página (F5).');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Guardar Cliente';
                    return;
                }
                const name = document.getElementById('clientName').value.trim();
                const cedula = document.getElementById('clientCedula').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();

                if (!name || !cedula || !phone) {
                    throw new Error('Por favor completa todos los campos obligatorios');
                }

                // Normalize phone to Colombian format
                let normalizedPhone = phone.replace(/[\s\-\(\)]/g, '');
                if (!normalizedPhone.startsWith('+57') && !normalizedPhone.startsWith('57')) {
                    if (normalizedPhone.length === 10) {
                        normalizedPhone = '+57' + normalizedPhone;
                    }
                }

                // Capture GPS location silently
                let location = null;
                try {
                    location = await getCurrentLocation();
                    console.log('📍 GPS capturado:', location);
                } catch (gpsError) {
                    console.warn('⚠️ No se pudo capturar GPS:', gpsError);
                    // Continue without GPS
                }

                console.log('Creating client with:', { panel_id: APP.collectorContext.panelId, nombre: name, cedula, telefono: normalizedPhone });

                const clientData = {
                    panel_id: APP.collectorContext.panelId,
                    nombre: name,
                    cedula: cedula,
                    telefono: normalizedPhone
                };

                // Add GPS data if available
                if (location) {
                    clientData.lat = location.latitude;
                    clientData.lng = location.longitude;
                }

                // 🆕 Check if REALLY offline
                if (isReallyOffline) {
                    console.log('🔴 MODO OFFLINE CONFIRMADO - Guardando en IndexedDB');
                    // Save offline using IndexedDB
                    console.log('📵 Offline - guardando cliente en IndexedDB...');
                    console.log('📝 Datos del cliente:', clientData);
                    
                    try {
                        const temp_id = await saveOffline('offline_clientes', clientData);
                        console.log('✅ Cliente guardado offline con temp_id:', temp_id);
                        
                        if (!temp_id) {
                            throw new Error('No se recibió temp_id de saveOffline');
                        }
                        
                        // 🆕 Agregar al cache de clientes inmediatamente (para que aparezca en lista)
                        const clienteConId = {
                            ...clientData,
                            id: temp_id, // Usar temp_id como ID temporal
                            temp_offline: true // Marcar como temporal
                        };
                        
                        console.log('📋 Agregando cliente al cache visual:', clienteConId);
                        const cachedClientes = await loadFromCache('clientes_cache') || [];
                        console.log(`📂 Clientes en cache antes: ${cachedClientes.length}`);
                        cachedClientes.push(clienteConId);
                        console.log(`📂 Clientes en cache después: ${cachedClientes.length}`);
                        
                        await saveToCache('clientes_cache', cachedClientes);
                        console.log('💾 Cliente agregado al cache local - guardado');
                        
                        await updateConnectionStatus();
                        
                        hideCreateClientForm();
                        
                        // 🆕 Cambiar a vista de clientes y recargar
                        console.log('🔄 Cambiando a vista de clientes...');
                        switchView('clientes');
                        
                        await loadClients();
                        
                        // Solo 1 mensaje
                        showSuccess(`✅ Cliente creado offline\ntemp_id: ${temp_id.substring(0, 30)}...\n\nSe sincronizará al volver online`);
                        return;
                    } catch (offlineError) {
                        console.error('❌ ERROR CRÍTICO guardando offline:', offlineError);
                        console.error('❌ Stack trace:', offlineError.stack);
                        showError('❌ ERROR: ' + offlineError.message + '\n\nRevisa la consola (F12) para más detalles.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Guardar Cliente';
                        return; // NO hacer throw para evitar doble mensaje
                    }
                }

                const { data, error } = await APP.supabase
                    .from('clients')
                    .insert(clientData)
                    .select()
                    .single();

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                console.log('✅ Client created:', data);
                showSuccess('Cliente creado exitosamente');
                hideCreateClientForm();
                
                // Reload clients list
                await loadClients();
            } catch (error) {
                console.error('❌ Error creating client:', error);
                showError('Error al crear cliente: ' + (error.message || 'Error desconocido'));
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Cliente';
            }
        }

        // Show create credit form (con overlay)
        async function showCreateCreditForm() {
            try {
                console.log('🆕 showCreateCreditForm called');
                console.log('📡 Estado conexión - APP.isOnline:', APP.isOnline);
                console.log('📡 Estado conexión - navigator.onLine:', navigator.onLine);
                
                // Forzar actualización del estado online
                APP.isOnline = navigator.onLine;
                console.log('📡 Estado actualizado - APP.isOnline:', APP.isOnline);
                
                // 🍎 iPhone: mostrar diagnóstico en pantalla
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                
                // Offline fallback: construir modal usando cache local
                if (!APP.isOnline) {
                    console.log('🔴🍎 Offline (iPhone/Android): construyendo modal crédito desde cache');
                    
                    const settingsRows = await loadFromCache('panel_settings_cache');
                    console.log('📦 Settings rows cargadas:', settingsRows?.length || 0);
                    const settings = {};
                    (settingsRows || []).forEach(s => {
                        try {
                            const val = (typeof s.value === 'string' && (s.value.startsWith('{') || s.value.startsWith('['))) ? JSON.parse(s.value) : s.value;
                            settings[s.key] = val;
                        } catch { settings[s.key] = s.value; }
                    });
                    const minCuotas = settings.min_cuotas || 30;
                    const maxCuotas = settings.max_cuotas || 90;
                    const cuotaMinima = settings.cuota_minima || 5000;
                    console.log('⚙️ Settings OK:', { minCuotas, maxCuotas, cuotaMinima });

                    const clientes = await loadFromCache('clientes_cache');
                    
                    if (!clientes || clientes.length === 0) {
                        showError('No hay datos en cache.\n\n1. Conéctate a internet\n2. Espera que se cargue el cache\n3. Luego podrás trabajar offline');
                        return;
                    }
                    
                    const creditos = await loadFromCache('creditos_cache');
                    console.log('💰 Créditos cache:', creditos?.length || 0);
                    
                    let activeByClient, clientsWithoutCredit;
                    try {
                        activeByClient = new Set((creditos || []).filter(c => c.estado === 'activo').map(c => (c.cliente_id || (c.clients && c.clients.id))).filter(Boolean));
                        clientsWithoutCredit = (clientes || []).filter(c => !activeByClient.has(c.id)).slice(0, 5);
                        console.log('✨ Clientes sin crédito:', clientsWithoutCredit.length);
                    } catch (e) {
                        console.error('❌ Error procesando clientes:', e);
                        clientsWithoutCredit = (clientes || []).slice(0, 5);
                        console.log('🔄 Usando todos los clientes:', clientsWithoutCredit.length);
                    }

                    let withoutCreditHTML = '';
                    try {
                        withoutCreditHTML = clientsWithoutCredit.map(c => `
                        <div onclick="selectClientForCredit('${c.id}', '${(c.nombre||'').replace(/'/g, "\\'")}', '${c.cedula||''}')" 
                            style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all 0.2s;margin-bottom:8px;"
                            onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                            <div style="font-weight:600;color:#333;margin-bottom:2px;">${c.nombre||''}</div>
                            <div style="font-size:13px;color:#666;">🆔 ${c.cedula||''}</div>
                            <button type="button" style="margin-top:6px;padding:6px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;font-weight:600;">
                                Asignar
                            </button>
                        </div>
                    `).join('');
                    } catch (e) {
                        console.error('❌ Error generando HTML clientes sin crédito:', e);
                    }
                    console.log('🖼️ HTML clientes generado, longitud:', withoutCreditHTML.length);

                    // Insertar modal básico (mismo layout que online)
                    console.log('📝 Insertando modal en DOM...');
                    console.log('📝 withoutCreditHTML length:', withoutCreditHTML.length);
                    console.log('📝 Generando HTML modal...');
                    
                    const modalHTML = `
                        <div id="creditModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;">
                            <div style="background:white;border-radius:15px;padding:20px;max-width:450px;width:100%;max-height:90vh;overflow-y:auto;position:relative;">
                                <button type="button" onclick="hideCreateCreditForm()" aria-label="Cerrar" 
                                    style="position:absolute;top:10px;right:10px;background:#ef4444;color:white;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;">✕</button>
                                <div id="clientSelectorView">
                                    <h3 style="margin:0 0 15px;color:#333;">Agregar Crédito</h3>
                                    <div style="margin-bottom:20px;">
                                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px;">Buscar cliente</label>
                                        <input type="text" id="clientSearchInput" placeholder="Cédula o nombre del cliente" 
                                            style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
                                        <div id="searchResults" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
                                    </div>
                                    ${withoutCreditHTML ? `
                                        <div style="margin-bottom:20px;">
                                            <h4 class="client-section-title" style="margin:0 0 10px;font-size:14px;color:#666;font-weight:600;">Clientes sin crédito activo</h4>
                                            ${withoutCreditHTML}
                                        </div>
                                    ` : ''}
                                </div>
                                <form id="newCreditForm" style="display:none;grid-template-columns:1fr;gap:12px;">
                                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                        <button type="button" onclick="showClientSelector()" style="background:none;border:none;font-size:20px;cursor:pointer;">←</button>
                                        <h3 style="margin:0;color:#333;flex:1;">Crear Crédito</h3>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:10px;">
                                        <div style="font-size:13px;color:#666;margin-bottom:2px;">Cliente seleccionado:</div>
                                        <div id="selectedClientName" style="font-weight:600;color:#333;"></div>
                                        <div id="selectedClientCedula" style="font-size:13px;color:#666;"></div>
                                    </div>
                                    <input type="hidden" id="creditClient" required>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Monto del crédito *</label>
                                        <input type="text" inputmode="numeric" id="creditAmount" class="form-input" required 
                                            placeholder="Ej: 500000" 
                                            style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;-webkit-appearance:none;-moz-appearance:textfield;">
                                        <small style="color:#666;font-size:12px;">Mínimo: $50,000 - Múltiplo de $1,000</small>
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Cuota diaria *</label>
                                        <input type="text" inputmode="numeric" id="creditDailyQuota" class="form-input" required 
                                            placeholder="Ej: 20000" 
                                            style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;-webkit-appearance:none;-moz-appearance:textfield;">
                                        <small style="color:#666;font-size:12px;">Mínimo recomendado: $${cuotaMinima.toLocaleString()}</small>
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Días calculados</label>
                                        <div id="creditCalculatedDays" style="padding:10px;background:#e0e7ff;border-radius:8px;font-weight:bold;text-align:center;">
                                            -
                                        </div>
                                        <small style="color:#666;font-size:12px;">Entre ${minCuotas} y ${maxCuotas} días</small>
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Total a pagar</label>
                                        <div id="creditTotal" style="padding:10px;background:#dcfce7;border-radius:8px;font-weight:bold;text-align:center;">
                                            -
                                        </div>
                                        <small style="color:#666;font-size:12px;">Interés base: 20%</small>
                                    </div>
                                    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
                                        <button type="button" onclick="hideCreateCreditForm()" class="btn-secondary" style="padding:12px 24px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;">Cancelar</button>
                                        <button id="createCreditBtn" type="button" onclick="createCredit({min_cuotas:${minCuotas},max_cuotas:${maxCuotas},cuota_minima:${cuotaMinima},interes_base:20})" class="btn-primary" style="padding:12px 24px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Crear Crédito</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    
                    console.log('📝 Modal HTML generado, longitud total:', modalHTML.length);
                    console.log('🔍 Intentando insertar modal en DOM...');
                    
                    // 🍎 iPhone: crear modal SIN template literals (Safari los trunca)
                    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                    if (isIOS) {
                        console.log('🍎 iPhone detectado: construyendo modal elemento por elemento...');
                        try {
                            // Overlay
                            const overlay = document.createElement('div');
                            overlay.id = 'creditModal';
                            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
                            
                            const container = document.createElement('div');
                            container.style.cssText = 'background:white;border-radius:15px;padding:20px;max-width:450px;width:100%;max-height:90vh;overflow-y:auto;position:relative;';
                            
                            // Botón cerrar
                            const closeBtn = document.createElement('button');
                            closeBtn.textContent = '✕';
                            closeBtn.onclick = hideCreateCreditForm;
                            closeBtn.style.cssText = 'position:absolute;top:10px;right:10px;background:#ef4444;color:white;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:18px;';
                            container.appendChild(closeBtn);
                            
                            // Selector view
                            const selectorView = document.createElement('div');
                            selectorView.id = 'clientSelectorView';
                            
                            const title = document.createElement('h3');
                            title.textContent = 'Agregar Crédito';
                            title.style.cssText = 'margin:0 0 15px;color:#333;';
                            selectorView.appendChild(title);
                            
                            const searchBox = document.createElement('div');
                            searchBox.style.cssText = 'margin-bottom:20px;';
                            const searchLabel = document.createElement('label');
                            searchLabel.textContent = 'Buscar cliente';
                            searchLabel.style.cssText = 'display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px;';
                            searchBox.appendChild(searchLabel);
                            
                            const searchInput = document.createElement('input');
                            searchInput.type = 'text';
                            searchInput.id = 'clientSearchInput';
                            searchInput.placeholder = 'Cédula o nombre del cliente';
                            searchInput.style.cssText = 'width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;';
                            searchBox.appendChild(searchInput);
                            
                            const searchResults = document.createElement('div');
                            searchResults.id = 'searchResults';
                            searchResults.style.cssText = 'margin-top:10px;max-height:200px;overflow-y:auto;';
                            searchBox.appendChild(searchResults);
                            selectorView.appendChild(searchBox);
                            
                            // Lista de clientes (mostrar TODOS si no hay sin crédito)
                            const clientsToShow = (clientsWithoutCredit && clientsWithoutCredit.length > 0) 
                                ? clientsWithoutCredit 
                                : (clientes || []).slice(0, 10); // Mostrar primeros 10 si no hay filtro
                            
                            if (clientsToShow && clientsToShow.length > 0) {
                                const clientsSection = document.createElement('div');
                                clientsSection.style.cssText = 'margin-bottom:20px;';
                                const clientsTitle = document.createElement('h4');
                                clientsTitle.textContent = clientsWithoutCredit && clientsWithoutCredit.length > 0 
                                    ? 'Clientes sin crédito activo' 
                                    : 'Todos los clientes';
                                clientsTitle.style.cssText = 'margin:0 0 10px;font-size:14px;color:#666;font-weight:600;';
                                clientsSection.appendChild(clientsTitle);
                                
                                clientsToShow.forEach(c => {
                                    const clientDiv = document.createElement('div');
                                    clientDiv.style.cssText = 'padding:12px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;margin-bottom:8px;background:white;';
                                    clientDiv.onclick = () => selectClientForCredit(c.id, c.nombre||'', c.cedula||'');
                                    
                                    const nameDiv = document.createElement('div');
                                    nameDiv.textContent = c.nombre || '';
                                    nameDiv.style.cssText = 'font-weight:600;color:#333;margin-bottom:2px;';
                                    clientDiv.appendChild(nameDiv);
                                    
                                    const cedulaDiv = document.createElement('div');
                                    cedulaDiv.textContent = '🆔 ' + (c.cedula || '');
                                    cedulaDiv.style.cssText = 'font-size:13px;color:#666;';
                                    clientDiv.appendChild(cedulaDiv);
                                    
                                    clientsSection.appendChild(clientDiv);
                                });
                                selectorView.appendChild(clientsSection);
                            } else {
                                const noClientsMsg = document.createElement('div');
                                noClientsMsg.textContent = 'No hay clientes disponibles. Usa el buscador arriba.';
                                noClientsMsg.style.cssText = 'padding:20px;text-align:center;color:#999;';
                                selectorView.appendChild(noClientsMsg);
                            }
                            
                            container.appendChild(selectorView);
                            
                            // Formulario (hidden)
                            const creditForm = document.createElement('form');
                            creditForm.id = 'newCreditForm';
                            creditForm.style.cssText = 'display:none;';
                            
                            // Header con back button
                            const formHeader = document.createElement('div');
                            formHeader.style.cssText = 'display:flex;align-items:center;gap:10px;margin-bottom:10px;';
                            const backBtn = document.createElement('button');
                            backBtn.type = 'button';
                            backBtn.textContent = '←';
                            backBtn.onclick = showClientSelector;
                            backBtn.style.cssText = 'background:none;border:none;font-size:20px;cursor:pointer;';
                            formHeader.appendChild(backBtn);
                            const formTitle = document.createElement('h3');
                            formTitle.textContent = 'Crear Crédito';
                            formTitle.style.cssText = 'margin:0;color:#333;flex:1;';
                            formHeader.appendChild(formTitle);
                            creditForm.appendChild(formHeader);
                            
                            // Cliente seleccionado box
                            const selectedBox = document.createElement('div');
                            selectedBox.style.cssText = 'background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:10px;';
                            const selectedLabel = document.createElement('div');
                            selectedLabel.textContent = 'Cliente:';
                            selectedLabel.style.cssText = 'font-size:13px;color:#666;';
                            selectedBox.appendChild(selectedLabel);
                            const selectedName = document.createElement('div');
                            selectedName.id = 'selectedClientName';
                            selectedName.style.cssText = 'font-weight:600;color:#333;';
                            selectedBox.appendChild(selectedName);
                            const selectedCedula = document.createElement('div');
                            selectedCedula.id = 'selectedClientCedula';
                            selectedCedula.style.cssText = 'font-size:13px;color:#666;';
                            selectedBox.appendChild(selectedCedula);
                            creditForm.appendChild(selectedBox);
                            
                            // Hidden input
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.id = 'creditClient';
                            hiddenInput.required = true;
                            creditForm.appendChild(hiddenInput);
                            
                            // Monto
                            const montoDiv = document.createElement('div');
                            montoDiv.style.cssText = 'margin-bottom:12px;';
                            const montoLabel = document.createElement('label');
                            montoLabel.textContent = 'Monto *';
                            montoLabel.style.cssText = 'display:block;margin-bottom:5px;font-weight:600;color:#374151;';
                            montoDiv.appendChild(montoLabel);
                            const montoInput = document.createElement('input');
                            montoInput.type = 'text';
                            montoInput.inputMode = 'numeric';
                            montoInput.id = 'creditAmount';
                            montoInput.required = true;
                            montoInput.placeholder = '500000';
                            montoInput.style.cssText = 'width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;';
                            montoDiv.appendChild(montoInput);
                            const montoHint = document.createElement('small');
                            montoHint.textContent = 'Mínimo: $50,000';
                            montoHint.style.cssText = 'color:#666;font-size:12px;';
                            montoDiv.appendChild(montoHint);
                            creditForm.appendChild(montoDiv);
                            
                            // Cuota
                            const cuotaDiv = document.createElement('div');
                            cuotaDiv.style.cssText = 'margin-bottom:12px;';
                            const cuotaLabel = document.createElement('label');
                            cuotaLabel.textContent = 'Cuota diaria *';
                            cuotaLabel.style.cssText = 'display:block;margin-bottom:5px;font-weight:600;color:#374151;';
                            cuotaDiv.appendChild(cuotaLabel);
                            const cuotaInput = document.createElement('input');
                            cuotaInput.type = 'text';
                            cuotaInput.inputMode = 'numeric';
                            cuotaInput.id = 'creditDailyQuota';
                            cuotaInput.required = true;
                            cuotaInput.placeholder = '20000';
                            cuotaInput.style.cssText = 'width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;';
                            cuotaDiv.appendChild(cuotaInput);
                            const cuotaHint = document.createElement('small');
                            cuotaHint.textContent = 'Mínimo: $' + cuotaMinima.toLocaleString();
                            cuotaHint.style.cssText = 'color:#666;font-size:12px;';
                            cuotaDiv.appendChild(cuotaHint);
                            creditForm.appendChild(cuotaDiv);
                            
                            // Días calculados
                            const diasDiv = document.createElement('div');
                            diasDiv.style.cssText = 'margin-bottom:12px;';
                            const diasLabel = document.createElement('label');
                            diasLabel.textContent = 'Días';
                            diasLabel.style.cssText = 'display:block;margin-bottom:5px;font-weight:600;color:#374151;';
                            diasDiv.appendChild(diasLabel);
                            const diasResult = document.createElement('div');
                            diasResult.id = 'creditCalculatedDays';
                            diasResult.textContent = '-';
                            diasResult.style.cssText = 'padding:10px;background:#e0e7ff;border-radius:8px;font-weight:bold;text-align:center;';
                            diasDiv.appendChild(diasResult);
                            creditForm.appendChild(diasDiv);
                            
                            // Total
                            const totalDiv = document.createElement('div');
                            totalDiv.style.cssText = 'margin-bottom:12px;';
                            const totalLabel = document.createElement('label');
                            totalLabel.textContent = 'Total a pagar';
                            totalLabel.style.cssText = 'display:block;margin-bottom:5px;font-weight:600;color:#374151;';
                            totalDiv.appendChild(totalLabel);
                            const totalResult = document.createElement('div');
                            totalResult.id = 'creditTotal';
                            totalResult.textContent = '-';
                            totalResult.style.cssText = 'padding:10px;background:#dcfce7;border-radius:8px;font-weight:bold;text-align:center;';
                            totalDiv.appendChild(totalResult);
                            creditForm.appendChild(totalDiv);
                            
                            // Botones
                            const buttonsDiv = document.createElement('div');
                            buttonsDiv.style.cssText = 'display:flex;gap:10px;margin-top:16px;';
                            const cancelBtn = document.createElement('button');
                            cancelBtn.type = 'button';
                            cancelBtn.textContent = 'Cancelar';
                            cancelBtn.onclick = hideCreateCreditForm;
                            cancelBtn.style.cssText = 'flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;';
                            buttonsDiv.appendChild(cancelBtn);
                            const submitBtn = document.createElement('button');
                            submitBtn.id = 'createCreditBtn';
                            submitBtn.type = 'button';
                            submitBtn.textContent = 'Crear Crédito';
                            submitBtn.onclick = () => createCredit({min_cuotas:minCuotas,max_cuotas:maxCuotas,cuota_minima:cuotaMinima,interes_base:20});
                            submitBtn.style.cssText = 'flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;';
                            buttonsDiv.appendChild(submitBtn);
                            creditForm.appendChild(buttonsDiv);
                            
                            container.appendChild(creditForm);
                            overlay.appendChild(container);
                            document.body.appendChild(overlay);
                            
                            // Configurar event listeners para iPhone
                            setTimeout(() => {
                                const searchInput = document.getElementById('clientSearchInput');
                                const searchResults = document.getElementById('searchResults');
                                
                                if (searchInput && searchResults) {
                                    const normalize = (v) => (v == null ? '' : String(v)).toLowerCase();
                                    const runFilter = () => {
                                        try {
                                            const q = normalize(searchInput.value);
                                            const filtered = (clientes || []).filter(c => 
                                                normalize(c.nombre).includes(q) || 
                                                normalize(c.cedula).includes(q)
                                            ).slice(0, 20);
                                            
                                            searchResults.innerHTML = '';
                                            filtered.forEach(c => {
                                                const div = document.createElement('div');
                                                div.style.cssText = 'padding:10px;border-bottom:1px solid #eee;cursor:pointer;';
                                                div.onclick = () => selectClientForCredit(c.id, c.nombre||'', c.cedula||'');
                                                
                                                const nameDiv = document.createElement('div');
                                                nameDiv.textContent = c.nombre || '';
                                                nameDiv.style.cssText = 'font-weight:600;';
                                                div.appendChild(nameDiv);
                                                
                                                const cedulaDiv = document.createElement('div');
                                                cedulaDiv.textContent = '🆔 ' + (c.cedula || '');
                                                cedulaDiv.style.cssText = 'font-size:12px;color:#666;';
                                                div.appendChild(cedulaDiv);
                                                
                                                searchResults.appendChild(div);
                                            });
                                            
                                            if (filtered.length === 0) {
                                                searchResults.innerHTML = '<div style="padding:10px;color:#999;text-align:center;">No se encontraron resultados</div>';
                                            }
                                        } catch (e) {
                                            console.error('Error en filtro:', e);
                                        }
                                    };
                                    
                                    ['input', 'keyup', 'change', 'search'].forEach(evt => 
                                        searchInput.addEventListener(evt, runFilter)
                                    );
                                }
                                
                                // Configurar cálculo automático
                                const amountInput = document.getElementById('creditAmount');
                                const quotaInput = document.getElementById('creditDailyQuota');
                                
                                if (amountInput && quotaInput) {
                                    const calculateCredit = () => {
                                        try {
                                            const amount = Number((amountInput.value||'').replace(/[^\d]/g, '')) || 0;
                                            const dailyQuota = Number((quotaInput.value||'').replace(/[^\d]/g, '')) || 0;
                                            
                                            if (amount > 0 && dailyQuota > 0) {
                                                const baseInterestRate = 0.2;
                                                const totalWithBaseInterest = amount * (1 + baseInterestRate);
                                                const idealInstallment = totalWithBaseInterest / 30;
                                                let adjustedInterestRate = baseInterestRate;
                                                let totalToPay = totalWithBaseInterest;
                                                
                                                if (dailyQuota < idealInstallment) {
                                                    adjustedInterestRate = baseInterestRate * (idealInstallment / dailyQuota);
                                                    totalToPay = amount * (1 + adjustedInterestRate);
                                                }
                                                
                                                const days = Math.ceil(totalToPay / dailyQuota);
                                                const realTotal = days * dailyQuota;
                                                
                                                const daysEl = document.getElementById('creditCalculatedDays');
                                                const totalEl = document.getElementById('creditTotal');
                                                
                                                if (daysEl) {
                                                    daysEl.textContent = days + ' días';
                                                    if (days < minCuotas || days > maxCuotas) {
                                                        daysEl.style.background = '#fee2e2';
                                                        daysEl.style.color = '#991b1b';
                                                    } else {
                                                        daysEl.style.background = '#e0e7ff';
                                                        daysEl.style.color = '#1e3a8a';
                                                    }
                                                }
                                                
                                                if (totalEl) {
                                                    totalEl.textContent = '$' + realTotal.toLocaleString();
                                                }
                                            }
                                        } catch (e) {
                                            console.error('Error calculando crédito:', e);
                                        }
                                    };
                                    
                                    ['input', 'keyup', 'change'].forEach(evt => {
                                        amountInput.addEventListener(evt, calculateCredit);
                                        quotaInput.addEventListener(evt, calculateCredit);
                                    });
                                }
                            }, 100);
                            
                        } catch (e) {
                            console.error('❌ Error creando modal iPhone:', e);
                            showError('Error iPhone: ' + e.message);
                            return;
                        }
                    } else {
                        // Android/PC: usar insertAdjacentHTML
                        try {
                            document.body.insertAdjacentHTML('beforeend', modalHTML);
                            console.log('✅✅✅ Modal insertado en DOM exitosamente');
                        } catch (e) {
                            console.error('❌❌❌ Error insertando modal:', e);
                            console.error('❌ Stack:', e.stack);
                            showError('Error mostrando formulario: ' + e.message);
                            return;
                        }
                    }
                    
                    // Verificar que se insertó
                    const modalCheck = document.getElementById('creditModal');
                    console.log('🔍 Modal encontrado en DOM:', modalCheck ? 'SÍ' : 'NO');
                    if (!modalCheck) {
                        console.error('❌ Modal no encontrado después de insertar');
                        showError('Modal no se pudo cargar');
                        return;
                    }

                    // Buscar en cache por nombre/cedula + calcular cuotas automáticamente
                    console.log('🔍 Configurando buscador y calculadora offline...');
                    setTimeout(() => {
                        const input = document.getElementById('clientSearchInput');
                        const results = document.getElementById('searchResults');
                        if (!input || !results) {
                            console.error('❌ No se encontraron elementos de búsqueda');
                            return;
                        }
                        console.log('✅ Elementos de búsqueda encontrados');
                        const normalize = (v) => (v == null ? '' : String(v)).toLowerCase();
                        const runFilter = () => {
                            try {
                                const q = normalize(input.value);
                                console.log('🔎 Filtrando por:', q);
                                const filtered = (clientes || []).filter(c => normalize(c.nombre).includes(q) || normalize(c.cedula).includes(q)).slice(0, 20);
                                console.log('📋 Resultados:', filtered.length);
                                results.innerHTML = filtered.map(c => `
                                    <div onclick="selectClientForCredit('${c.id}','${(c.nombre||'').replace(/'/g, "\\'")}','${c.cedula||''}')" 
                                        style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;">
                                        <div style="font-weight:600;">${c.nombre||''}</div>
                                        <div style="font-size:12px;color:#666;">🆔 ${c.cedula||''}</div>
                                    </div>
                                `).join('');
                            } catch (e) {
                                console.error('❌ Error en runFilter:', e);
                            }
                        };
                        ['input','keyup','change','search'].forEach(evt => input.addEventListener(evt, runFilter));
                        runFilter();
                        console.log('✅ Buscador configurado');

                        // Calcular cuotas automáticamente
                        const amountInput = document.getElementById('creditAmount');
                        const quotaInput = document.getElementById('creditDailyQuota');
                        console.log('💰 Inputs encontrados:', { amountInput: !!amountInput, quotaInput: !!quotaInput });
                        
                        function calculateCredit() {
                            try {
                                const amount = Number((amountInput?.value||'').replace(/[^\d]/g, '')) || 0;
                                const dailyQuota = Number((quotaInput?.value||'').replace(/[^\d]/g, '')) || 0;
                                console.log('🧮 Calculando:', { amount, dailyQuota });
                            if (amount > 0 && dailyQuota > 0) {
                                const baseInterestRate = 0.2;
                                const totalWithBaseInterest = amount * (1 + baseInterestRate);
                                const idealInstallment = totalWithBaseInterest / 30;
                                let adjustedInterestRate = baseInterestRate;
                                let totalToPay = totalWithBaseInterest;
                                if (dailyQuota < idealInstallment) {
                                    adjustedInterestRate = baseInterestRate * (idealInstallment / dailyQuota);
                                    totalToPay = amount * (1 + adjustedInterestRate);
                                }
                                const days = Math.ceil(totalToPay / dailyQuota);
                                const realTotal = days * dailyQuota;
                                const daysEl = document.getElementById('creditCalculatedDays');
                                const totalEl = document.getElementById('creditTotal');
                                if (daysEl) daysEl.textContent = days + ' días';
                                if (totalEl) totalEl.textContent = '$' + realTotal.toLocaleString();
                                if (daysEl && (days < minCuotas || days > maxCuotas)) {
                                    daysEl.style.background = '#fee2e2';
                                    daysEl.style.color = '#991b1b';
                                } else if (daysEl) {
                                    daysEl.style.background = '#e0e7ff';
                                    daysEl.style.color = '#1e3a8a';
                                }
                            }
                            } catch (e) {
                                console.error('❌ Error en calculateCredit:', e);
                            }
                        }
                        if (amountInput) {
                            ['input','keyup','change'].forEach(evt => amountInput.addEventListener(evt, calculateCredit));
                            console.log('✅ Listeners en creditAmount agregados');
                        }
                        if (quotaInput) {
                            ['input','keyup','change'].forEach(evt => quotaInput.addEventListener(evt, calculateCredit));
                            console.log('✅ Listeners en creditDailyQuota agregados');
                        }
                        console.log('✅ Cálculo automático configurado');
                    }, 150);

                    console.log('✅ Modal offline insertado, retornando');
                    return; // No continuar con flujo online
                }
                // Get settings
                const { data: settingsData } = await APP.supabase
                    .from('settings')
                    .select('key, value')
                    .eq('panel_id', APP.collectorContext.panelId);
                
                const settings = {};
                if (settingsData) {
                    settingsData.forEach(s => {
                        try {
                            settings[s.key] = typeof s.value === 'string' && (s.value.startsWith('{') || s.value.startsWith('['))
                                ? JSON.parse(s.value)
                                : s.value;
                        } catch {
                            settings[s.key] = s.value;
                        }
                    });
                }
                
                // Set defaults
                const minCuotas = settings.min_cuotas || 30;
                const maxCuotas = settings.max_cuotas || 90;
                const cuotaMinima = settings.cuota_minima || 5000;
                const interesBase = settings.interes_base || 20;
                    
                // Get all clients and filter out those with active credits
                const { data: allClients } = await APP.supabase
                    .from('clients')
                    .select('id, nombre, cedula')
                    .eq('panel_id', APP.collectorContext.panelId)
                    .order('created_at', { ascending: false });
                
                const { data: activeLoans } = await APP.supabase
                    .from('prestamos')
                    .select('cliente_id')
                    .eq('panel_id', APP.collectorContext.panelId)
                    .in('estado', ['activo', 'vencido']);
                
                const activeClientIds = new Set((activeLoans || []).map(l => l.cliente_id));
                const clientsWithoutCredit = (allClients || [])
                    .filter(c => !activeClientIds.has(c.id))
                    .slice(0, 3);
                
                // Get clients with recently completed credits
                const { data: recentlyCompleted } = await APP.supabase
                    .from('prestamos')
                    .select('cliente_id, clients(id, nombre, cedula), fecha_fin')
                    .eq('panel_id', APP.collectorContext.panelId)
                    .eq('estado', 'completado')
                    .order('fecha_fin', { ascending: false })
                    .limit(2);
                
                // Build suggestions HTML
                const withoutCreditHTML = (clientsWithoutCredit || []).map(c => `
                    <div onclick="selectClientForCredit('${c.id}', '${c.nombre.replace(/'/g, "\\'")}', '${c.cedula}')" 
                        style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all 0.2s;margin-bottom:8px;"
                        onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        <div style="font-weight:600;color:#333;margin-bottom:2px;">${c.nombre}</div>
                        <div style="font-size:13px;color:#666;">🆔 ${c.cedula}</div>
                        <button type="button" style="margin-top:6px;padding:6px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;font-weight:600;">
                            Asignar
                        </button>
                    </div>
                `).join('');
                
                const completedHTML = (recentlyCompleted || []).map(p => `
                    <div onclick="selectClientForCredit('${p.clients.id}', '${p.clients.nombre.replace(/'/g, "\\'")}', '${p.clients.cedula}')" 
                        style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all 0.2s;margin-bottom:8px;"
                        onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        <div style="font-weight:600;color:#333;margin-bottom:2px;">${p.clients.nombre}</div>
                        <div style="font-size:12px;color:#666;margin-bottom:4px;">Terminó el ${p.fecha_fin || 'N/A'}</div>
                        <button type="button" style="padding:6px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-size:12px;font-weight:600;">
                            Ofrecer nuevo crédito
                        </button>
                    </div>
                `).join('');
                
                // Crear modal con selector de cliente
                document.body.insertAdjacentHTML('beforeend', `
                    <div id="creditModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;">
                        <div style="background:white;border-radius:15px;padding:20px;max-width:450px;width:100%;max-height:90vh;overflow-y:auto;">
                            <div id="clientSelectorView">
                                <h3 style="margin:0 0 15px;color:#333;">Agregar Crédito</h3>
                                
                                <!-- Search Bar -->
                                <div style="margin-bottom:20px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px;">Buscar cliente</label>
                                    <input type="text" id="clientSearchInput" placeholder="Cédula o nombre del cliente" 
                                        style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
                                    <div id="searchResults" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
                                </div>
                                
                                <!-- Últimos 3 clientes sin crédito -->
                                ${withoutCreditHTML ? `
                                    <div style="margin-bottom:20px;">
                                        <h4 class="client-section-title" style="margin:0 0 10px;font-size:14px;color:#666;font-weight:600;">Últimos 3 clientes sin crédito</h4>
                                        ${withoutCreditHTML}
                                    </div>
                                ` : ''}
                                
                                <!-- 2 clientes recién finalizados -->
                                ${completedHTML ? `
                                    <div style="margin-bottom:20px;">
                                        <h4 class="client-section-title" style="margin:0 0 10px;font-size:14px;color:#666;font-weight:600;">Clientes recién finalizados</h4>
                                        ${completedHTML}
                                    </div>
                                ` : ''}
                                
                                <button type="button" onclick="hideCreateCreditForm()" style="width:100%;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                    Cancelar
                                </button>
                            </div>
                            
                            <!-- Credit Form (hidden initially) -->
                            <form id="newCreditForm" style="display:none;grid-template-columns:1fr;gap:12px;">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                    <button type="button" onclick="showClientSelector()" style="background:none;border:none;font-size:20px;cursor:pointer;">←</button>
                                    <h3 style="margin:0;color:#333;flex:1;">Crear Crédito</h3>
                                </div>
                                
                                <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:10px;">
                                    <div style="font-size:13px;color:#666;margin-bottom:2px;">Cliente seleccionado:</div>
                                    <div id="selectedClientName" style="font-weight:600;color:#333;"></div>
                                    <div id="selectedClientCedula" style="font-size:13px;color:#666;"></div>
                                </div>
                                
                                <input type="hidden" id="creditClient" required>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Monto del crédito *</label>
                                    <input type="text" inputmode="numeric" id="creditAmount" class="form-input" required 
                                        placeholder="Ej: 500000" 
                                        style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;-webkit-appearance:none;-moz-appearance:textfield;">
                                    <small style="color:#666;font-size:12px;">Mínimo: $50,000 - Múltiplo de $1,000</small>
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Cuota diaria *</label>
                                    <input type="text" inputmode="numeric" id="creditDailyQuota" class="form-input" required 
                                        placeholder="Ej: ${cuotaMinima}" 
                                        style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;-webkit-appearance:none;-moz-appearance:textfield;">
                                    <small style="color:#666;font-size:12px;">Mínimo: $${cuotaMinima.toLocaleString()}</small>
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Días calculados</label>
                                    <div id="creditCalculatedDays" class="credit-calc-box" style="padding:10px;background:#e0e7ff;border-radius:8px;font-weight:bold;text-align:center;">
                                        -
                                    </div>
                                    <small style="color:#666;font-size:12px;">Rango: ${minCuotas} - ${maxCuotas} días</small>
                                </div>
                                <div style="margin-bottom:15px;">
                                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#374151;">Total a pagar</label>
                                    <div id="creditTotal" class="credit-total-box" style="padding:10px;background:#dcfce7;border-radius:8px;font-weight:bold;text-align:center;">
                                        -
                                    </div>
                                    <small style="color:#666;font-size:12px;">Interés base: ${interesBase}%</small>
                                </div>
                                <div style="display:flex;gap:10px;margin-top:10px;">
                                    <button type="submit" class="btn btn-success" style="flex:1;padding:12px;">Crear Crédito</button>
                                    <button type="button" onclick="hideCreateCreditForm()" class="btn" style="flex:1;padding:12px;background:#6c757d;color:white;">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `);
                    
                    // Add calculation listeners
                    const amountInput = document.getElementById('creditAmount');
                    const quotaInput = document.getElementById('creditDailyQuota');
                    
                    function calculateCredit() {
                        // Remove non-numeric characters and convert to number
                        const amount = Number(amountInput.value.replace(/[^\d]/g, '')) || 0;
                        const dailyQuota = Number(quotaInput.value.replace(/[^\d]/g, '')) || 0;
                        
                        if (amount > 0 && dailyQuota > 0) {
                            // Calculate base interest (for 30 days)
                            const baseInterestRate = interesBase / 100;
                            const totalWithBaseInterest = amount * (1 + baseInterestRate);
                            const idealInstallment = totalWithBaseInterest / 30; // ideal for 30 days
                            
                            // Adjust interest if installment is lower than ideal
                            let adjustedInterestRate = baseInterestRate;
                            let totalToPay = totalWithBaseInterest;
                            
                            if (dailyQuota < idealInstallment) {
                                // If quota is lower, increase interest proportionally
                                adjustedInterestRate = baseInterestRate * (idealInstallment / dailyQuota);
                                totalToPay = amount * (1 + adjustedInterestRate);
                            }
                            
                            // Calculate number of days (round up)
                            const days = Math.ceil(totalToPay / dailyQuota);
                            
                            // IMPORTANT: Real total is days × daily quota (rounded to installments)
                            const realTotal = days * dailyQuota;
                            
                            // Display results
                            document.getElementById('creditCalculatedDays').textContent = `${days} días`;
                            document.getElementById('creditTotal').textContent = `$${realTotal.toLocaleString()}`;
                            
                            // Validate
                            if (days < minCuotas || days > maxCuotas) {
                                document.getElementById('creditCalculatedDays').style.background = '#fee2e2';
                                document.getElementById('creditCalculatedDays').style.color = '#991b1b';
                            } else {
                                document.getElementById('creditCalculatedDays').style.background = '#e0e7ff';
                                document.getElementById('creditCalculatedDays').style.color = '#1e3a8a';
                            }
                        }
                    }
                    
                    amountInput.addEventListener('input', calculateCredit);
                    quotaInput.addEventListener('input', calculateCredit);
                    
                const newForm = document.getElementById('newCreditForm');
                if (newForm) {
                newForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await createCredit(settings);
                });
                }
                
                // Setup client search
                const searchInput = document.getElementById('clientSearchInput');
                searchInput.addEventListener('input', async (e) => {
                    const term = e.target.value.trim();
                    if (term.length < 2) {
                        document.getElementById('searchResults').innerHTML = '';
                        return;
                    }
                    
                    // Si offline, buscar en cache
                    let results;
                    if (!APP.isOnline) {
                        const normalize = (v) => (v == null ? '' : String(v)).toLowerCase();
                        const clientesCache = await loadFromCache('clientes_cache');
                        const q = normalize(term);
                        results = (clientesCache || []).filter(c => normalize(c.nombre).includes(q) || normalize(c.cedula).includes(q)).slice(0, 5);
                    } else {
                        const resp = await APP.supabase
                            .from('clients')
                            .select('id, nombre, cedula')
                            .eq('panel_id', APP.collectorContext.panelId)
                            .or(`nombre.ilike.%${term}%,cedula.ilike.%${term}%`)
                            .limit(5);
                        results = resp.data;
                    }
                    
                    const resultsHTML = (results || []).map(c => `
                        <div onclick="selectClientForCredit('${c.id}', '${c.nombre.replace(/'/g, "\\'")}', '${c.cedula}')" 
                            style="padding:10px;border:1px solid #e5e7eb;border-radius:6px;cursor:pointer;margin-bottom:6px;background:white;"
                            onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                            <div style="font-weight:600;color:#333;">${c.nombre}</div>
                            <div style="font-size:12px;color:#666;">🆔 ${c.cedula}</div>
                        </div>
                    `).join('');
                    
                    document.getElementById('searchResults').innerHTML = resultsHTML || '<div style="padding:10px;color:#999;text-align:center;">No se encontraron resultados</div>';
                });
                } catch (error) {
                    console.error('❌❌❌ Error general en showCreateCreditForm:', error);
                    console.error('Stack:', error.stack);
                    showError('Error al cargar el formulario: ' + error.message);
                }
        }
        
        // Select client for credit
        function selectClientForCredit(clientId, clientName, clientCedula) {
            document.getElementById('creditClient').value = clientId;
            document.getElementById('selectedClientName').textContent = clientName;
            document.getElementById('selectedClientCedula').textContent = `🆔 ${clientCedula}`;
            
            // Hide selector, show form
            document.getElementById('clientSelectorView').style.display = 'none';
            document.getElementById('newCreditForm').style.display = 'grid';
        }
        
        // Show client selector (back button)
        function showClientSelector() {
            document.getElementById('clientSelectorView').style.display = 'block';
            document.getElementById('newCreditForm').style.display = 'none';
        }
        
        // Hide create credit form
        function hideCreateCreditForm() {
            document.getElementById('creditModal')?.remove();
        }
        
        // Create credit
        async function createCredit(settings) {
            const submitBtn = document.getElementById('createCreditBtn') 
                || document.querySelector('#newCreditForm .btn-primary') 
                || document.querySelector('#newCreditForm button[type="submit"]');
            const formEl = document.getElementById('newCreditForm');
            if (!formEl) {
                showError('Formulario no disponible. Selecciona un cliente primero.');
                return;
            }
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creando...';
            }
            
            try {
                const clientId = document.getElementById('creditClient').value;
                // Remove non-numeric characters and convert to number
                const amount = Number(document.getElementById('creditAmount').value.replace(/[^\d]/g, ''));
                const dailyQuota = Number(document.getElementById('creditDailyQuota').value.replace(/[^\d]/g, ''));
                
                if (!clientId) {
                    throw new Error('Selecciona un cliente');
                }
                
                if (!amount || amount < 50000) {
                    throw new Error('El monto mínimo es $50,000');
                }
                
                if (amount % 1000 !== 0) {
                    throw new Error('El monto debe ser múltiplo de $1,000');
                }
                
                const minCuotas = settings.min_cuotas || 30;
                const maxCuotas = settings.max_cuotas || 90;
                const cuotaMinima = settings.cuota_minima || 5000;
                const interesBase = settings.interes_base || 20;
                
                if (dailyQuota < cuotaMinima) {
                    throw new Error(`La cuota mínima es $${cuotaMinima.toLocaleString()}`);
                }
                
                // Calculate with progressive interest (same logic as main panel)
                const baseInterestRate = interesBase / 100;
                const totalWithBaseInterest = amount * (1 + baseInterestRate);
                const idealInstallment = totalWithBaseInterest / 30; // ideal for 30 days
                
                let adjustedInterestRate = baseInterestRate;
                let totalToPay = totalWithBaseInterest;
                
                if (dailyQuota < idealInstallment) {
                    // If quota is lower, increase interest proportionally
                    adjustedInterestRate = baseInterestRate * (idealInstallment / dailyQuota);
                    totalToPay = amount * (1 + adjustedInterestRate);
                }
                
                const days = Math.ceil(totalToPay / dailyQuota);
                
                if (days < minCuotas) {
                    throw new Error(`El crédito debe tener mínimo ${minCuotas} días`);
                }
                
                if (days > maxCuotas) {
                    throw new Error(`El crédito no puede superar ${maxCuotas} días`);
                }
                
                // Calculate real total (days × daily quota)
                const total = days * dailyQuota;
                
                console.log('Creating credit:', { clientId, amount, dailyQuota, days, total, adjustedInterestRate });
                
                // Capture GPS location silently
                let location = null;
                try {
                    location = await getCurrentLocation();
                    console.log('📍 GPS capturado en crédito:', location);
                } catch (gpsError) {
                    console.warn('⚠️ No se pudo capturar GPS en crédito:', gpsError);
                }

                // Create loan (offline-first) - SIN lat/lng (tabla prestamos no tiene esos campos)
                const loanData = {
                    panel_id: APP.collectorContext.panelId,
                    cliente_id: clientId,
                    cobrador_id: APP.collectorContext.collectorId,
                    created_by: APP.collectorContext.userId || APP.collectorContext.collectorId,
                    monto_prestado: amount,
                    cuota_diaria: dailyQuota,
                    total_dias: days,
                    fecha_inicio: getLocalToday(),
                    estado: 'activo'
                };

                if (!APP.isOnline) {
                    // Guardar offline
                    const tempId = await saveOffline('offline_creditos', loanData);
                    showSuccess(`💾 Crédito guardado offline\ntemp_id: ${String(tempId).substring(0, 28)}...\n\nSe sincronizará cuando haya conexión`);
                    hideCreateCreditForm();
                    // Optimista: actualizar cache de créditos
                    try {
                        const creditos = await loadFromCache('creditos_cache');
                        creditos.push({
                            id: tempId,
                            monto_prestado: amount,
                            cuota_diaria: dailyQuota,
                            total_dias: days,
                            estado: 'activo',
                            fecha_inicio: getLocalToday(),
                            clients: { nombre: document.getElementById('selectedClientName').textContent || '' }
                        });
                        await saveToCache('creditos_cache', creditos);
                    } catch {}
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Crear Crédito';
                    return;
                }

                const { data, error } = await APP.supabase
                    .from('prestamos')
                    .insert(loanData)
                    .select()
                    .single();
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('✅ Credit created:', data);
                showSuccess('Crédito creado exitosamente');
                hideCreateCreditForm();
                
                // Reload credits list
                await loadCredits();
            } catch (error) {
                console.error('❌ Error creating credit:', error);
                showError('Error al crear crédito: ' + (error.message || 'Error desconocido'));
                submitBtn.disabled = false;
                submitBtn.textContent = 'Crear Crédito';
            }
        }

        // Setup offline handling
        function setupOfflineHandling() {
            console.log('🔧 Configurando manejo offline con IndexedDB...');
            
            // 🆕 Use sync.js connection listeners
            setupConnectionListeners();
            
            // Listen for messages from Service Worker
            navigator.serviceWorker?.addEventListener('message', (event) => {
                if (event.data.type === 'SYNC_OFFLINE_DATA') {
                    console.log('📬 Service Worker requests sync');
                    syncOfflineData();
                }
            });

            // Update initial status
            updateConnectionStatus();
            
            // Enable Service Worker for offline caching
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.warn('⚠️ Service Worker registration failed:', error);
                    });
            }
        }

        // 🆕 Update connection status (usa IndexedDB ahora)
        async function updateConnectionStatus() {
            // 🆕 Actualizar indicador visual de conexión
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                const isOnline = navigator.onLine && APP.isOnline;
                statusIndicator.className = isOnline ? 'status-indicator status-online' : 'status-indicator status-offline';
                console.log(`🔌 Estado de conexión actualizado: ${isOnline ? 'Online ✅' : 'Offline 📵'}`);
            }

            // Get pending count from IndexedDB
            const pendingCount = await countOfflinePending();

            // Update header badge if exists
            const badge = document.getElementById('offlineBadge');
            if (badge) {
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }

            // Show toast if offline
            if (!APP.isOnline && pendingCount > 0) {
                console.log(`📦 ${pendingCount} items pendientes de sincronizar`);
            }
        }


        // 🆕 syncOfflineData() ahora está en sync.js - ya no se necesita aquí

        // Show login
        function showLogin() {
            document.body.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>Cobrador</h1>
                        <p>Inicia sesión para continuar</p>
                    </div>
                    <div class="content">
                        <form id="loginForm">
                            <div class="form-group">
                                <label class="form-label" for="email">Email</label>
                                <input type="email" id="email" class="form-input" required value="jhonalexander@gmail.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="password">Contraseña</label>
                                <input type="password" id="password" class="form-input" required>
                            </div>
                            <div id="loginError" style="display: none; color: #f87171; margin: 10px 0; padding: 10px; background: rgba(248, 113, 113, 0.1); border-radius: 8px;"></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">Iniciar Sesión</button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');
                const loginError = document.getElementById('loginError');

                loginBtn.disabled = true;
                loginBtn.textContent = 'Iniciando...';
                loginError.style.display = 'none';

                try {
                    console.log('Attempting login with:', email);
                    console.log('Supabase client:', APP.supabase ? 'initialized' : 'NOT initialized');
                    
                    const { data, error } = await APP.supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    console.log('Login response:', { data, error });

                    if (error) throw error;

                    console.log('Login successful, reloading...');
                    // Reload page to initialize app
                    location.reload();
                } catch (error) {
                    console.error('Login error:', error);
                    loginError.textContent = error.message || 'Error al iniciar sesión. Verifica tus credenciales.';
                    loginError.style.display = 'block';
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesión';
                }
            });
        }

        // Logout
        async function logout() {
            try {
                console.log('Logging out...');
                const { error } = await APP.supabase.auth.signOut();
                if (error) {
                    console.error('Logout error:', error);
                    throw error;
                }
                console.log('Logout successful, reloading...');
                // Clear app context
                APP.collectorContext = null;
                // Reload page
                window.location.href = window.location.pathname;
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error al cerrar sesión: ' + error.message);
            }
        }

        // Show error
        function showError(message) {
            console.error('Error:', message);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.cssText = 'padding: 15px; margin: 15px 0; background: #fee; border: 1px solid #fcc; border-radius: 8px; color: #c33;';
            
            const content = document.querySelector('.content');
            if (content) {
                content.insertBefore(errorDiv, content.firstChild);
            } else {
                document.body.appendChild(errorDiv);
            }
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Show success
        function showSuccess(message) {
            console.log('Success:', message);
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.cssText = 'padding: 15px; margin: 15px 0; background: #efe; border: 1px solid #cfc; border-radius: 8px; color: #3c3;';
            
            const content = document.querySelector('.content');
            if (content) {
                content.insertBefore(successDiv, content.firstChild);
            } else {
                document.body.appendChild(successDiv);
            }
            setTimeout(() => successDiv.remove(), 3000);
        }

        // ============ NEW NAVIGATION SYSTEM ============
        
        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-mode');
            
            if (isDark) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Go to home
        function goHome() {
            document.getElementById('homeGrid').style.display = 'grid';
            document.getElementById('viewsContainer').style.display = 'none';
            
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
        }
        
        // Open view
        function openView(viewName) {
            document.getElementById('homeGrid').style.display = 'none';
            document.getElementById('viewsContainer').style.display = 'block';
            
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.add('active');
                loadViewData(viewName);
            }
        }
        
        // Setup new navigation
        function setupNewNavigation() {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.add(savedTheme + '-mode');
            
            // Theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // Home menu cards
            document.querySelectorAll('.menu-card').forEach(card => {
                card.addEventListener('click', () => {
                    const view = card.dataset.view;
                    if (view) openView(view);
                });
            });
        }
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupNewNavigation();
            checkGpsOnStart(); // Check GPS before init
        });
    </script>
</body>
</html>



